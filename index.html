<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Project Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles */
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .sidebar {
            transition: all 0.3s ease;
            /* Sticky sidebar */
            position: sticky;
            top: 0;
            height: 100vh; /* Full height */
            overflow-y: auto; /* Scrollable if content overflows */
            z-index: 30; /* Below header, above main content */
        }
        /* Sticky header */
        header {
            position: sticky;
            top: 0;
            z-index: 40; /* Above sidebar */
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 30px -8px rgba(0, 0, 0, 0.15), 0 12px 12px -6px rgba(0, 0, 0, 0.06); /* More pronounced shadow */
        }
        .countdown {
            font-family: monospace;
        }
        /* Adjusted max-height for charts to prevent overflow */
        #progress-chart, #faculty-dashboard-chart, #submission-timeline, #grade-distribution, #faculty-status-chart, #faculty-timeline-chart, #faculty-performance-chart, #student-performance-chart, #admin-activity-chart, #admin-user-chart, #admin-project-status-chart, #admin-monthly-trends-chart {
            max-height: 250px !important; /* Consistent height for all charts */
            height: 250px !important; /* Fixed height to prevent expansion */
        }
        
        /* Fix for chart containers */
        .chart-container {
            height: 250px !important;
            max-height: 250px !important;
            overflow: hidden;
        }
        
        /* Prevent content sections from expanding beyond viewport */
        .content-section {
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        /* Fix for student dashboard grid to prevent expansion */
        .student-dashboard-grid {
            max-height: none;
            overflow: visible;
        }
        
        /* Ensure charts don't cause parent containers to expand */
        canvas {
            max-width: 100% !important;
            max-height: 250px !important;
        }
        /* Enhanced focus styles for inputs */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: transparent; /* Hide default border */
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.4); /* Purple ring focus */
        }
        /* Modal animation */
        .modal-content-animated {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-out;
        }
        .modal-content-animated.show {
            transform: scale(1);
            opacity: 1;
        }
        /* Calendar styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0; /* Light gray border for cells */
            border: 1px solid #e2e8f0;
        }
        .calendar-day-header {
            background-color: #f7fafc;
            padding: 8px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.875rem;
        }
        .calendar-day {
            background-color: #ffffff;
            min-height: 100px;
            padding: 8px;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }
        .calendar-day.current-month {
            color: #2d3748;
        }
        .calendar-day.other-month {
            color: #a0aec0;
            background-color: #f0f4f8;
        }
        .calendar-day.today {
            background-color: #e0f2fe;
            border: 2px solid #3b82f6;
        }
        .calendar-event {
            background-color: #a78bfa;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 2px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-event.deadline {
            background-color: #ef4444;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        body.dark .bg-white {
            background-color: #2d3748; /* Darker card/panel background */
            color: #e2e8f0;
        }
        body.dark .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark .text-gray-600 {
            color: #a0aec0;
        }
        body.dark .text-gray-500 {
            color: #718096;
        }
        body.dark .border-gray-200 {
            border-color: #4a5568;
        }
        body.dark .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: #4a5568;
        }
        body.dark .bg-gray-50 {
            background-color: #4a5568;
        }
        body.dark .hover\:bg-gray-50:hover {
            background-color: #616e7f;
        }
        body.dark .bg-gray-100 {
            background-color: #1a202c;
        }
        body.dark .border-gray-300 {
            border-color: #616e7f;
        }
        body.dark input, body.dark select, body.dark textarea {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        body.dark input::placeholder, body.dark textarea::placeholder {
            color: #a0aec0;
        }
        body.dark .sidebar {
            background-color: #2d3748;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        body.dark .sidebar-link {
            color: #cbd5e0;
        }
        body.dark .sidebar-link:hover {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark .sidebar-link.active {
            background-color: #6b46c1; /* A slightly different purple for active in dark mode */
            color: #e2e8f0;
        }
        body.dark .bg-gray-200 {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark .hover\:bg-gray-300:hover {
            background-color: #616e7f;
        }
        body.dark .calendar-grid {
            background-color: #4a5568;
            border-color: #4a5568;
        }
        body.dark .calendar-day-header {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark .calendar-day {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark .calendar-day.other-month {
            background-color: #1a202c;
            color: #718096;
        }
        body.dark .calendar-day.today {
            background-color: #4299e1; /* A blue for today in dark mode */
            border-color: #63b3ed;
        }
        body.dark .modal-content-animated {
            background-color: #2d3748;
        }
        body.dark .bg-blue-50 {
            background-color: #3182ce; /* Darker blue for messages */
            color: #e2e8f0;
        }
        body.dark .hover\:bg-gray-100:hover {
            background-color: #4a5568;
        }

        /* Section transition */
        .content-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .content-section.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Collapsible sidebar for mobile */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 250px;
                z-index: 50;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
            }
            .sidebar.open {
                left: 0;
            }
            .main-content-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 45;
            }
            .main-content-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl transition-all duration-300 ease-out modal-content-animated">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                <button id="close-auth" class="text-gray-500 hover:text-gray-700 text-xl" aria-label="Close login modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button id="login-tab" class="px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600 transition-colors duration-200" role="tab" aria-selected="true" aria-controls="login-form">Login</button>
                    <button id="register-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-purple-600 transition-colors duration-200" role="tab" aria-selected="false" aria-controls="register-form">Register</button>
                </div>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" role="tabpanel" aria-labelledby="login-tab">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="login-username">Email</label>
                    <input type="email" id="login-username" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Enter your email" aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="login-password">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Enter your password" aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="login-role">Role</label>
                    <select id="login-role" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-required="true">
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                    </select>
                </div>
                <button id="login-btn" class="w-full gradient-bg text-white py-3 rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">Login</button>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" style="display: none;" role="tabpanel" aria-labelledby="register-tab">
                <div class="mb-4">
                   <label class="block text-gray-700 mb-2" for="register-email">Email</label>
                    <input type="email" id="register-email"
                      class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                      placeholder="Enter your college email" aria-required="true" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-password">Password</label>
                    <input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Create a password" aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-name">Full Name</label>
                    <input type="text" id="register-name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Your full name" aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-role">Role</label>
                    <select id="register-role" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-required="true">
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button id="register-btn" class="w-full gradient-bg text-white py-3 rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">Register</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen flex flex-col" style="display: none;">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-md p-4 md:p-0">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button id="sidebar-toggle" class="md:hidden text-white text-2xl mr-3" aria-label="Toggle sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <i class="fas fa-project-diagram text-3xl"></i>
                    <h1 class="text-2xl font-bold">College Project Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Theme toggle button added here -->
                    <button id="theme-toggle" class="text-white hover:text-gray-200 text-lg transition-colors duration-200" aria-label="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="notification-btn" class="text-white hover:text-gray-200 text-lg transition-colors duration-200 relative" aria-label="Show notifications">
                        <i class="fas fa-bell"></i>
                        <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500" style="display: none;" aria-hidden="true"></span>
                    </button>
                    <span id="current-user" class="font-medium text-lg"></span>
                    <span id="user-role" class="px-4 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold"></span>
                    <button id="logout-btn" class="text-white hover:text-gray-200 text-lg transition-colors duration-200" aria-label="Logout">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="flex flex-1 relative">
            <!-- Sidebar -->
            <nav id="sidebar" class="sidebar w-64 bg-white shadow-lg flex-shrink-0">
                <div class="p-4">
                    <div id="student-menu" style="display: none;">
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Dashboard</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200 active" data-section="student-dashboard" aria-current="page"><i class="fas fa-tachometer-alt mr-3 text-lg"></i>My Dashboard</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-projects"><i class="fas fa-list-ol mr-3 text-lg"></i>My Projects</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-submissions"><i class="fas fa-file-upload mr-3 text-lg"></i>Submissions</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-claim-projects"><i class="fas fa-hand-sparkles mr-3 text-lg"></i>Claim Projects</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-create-project"><i class="fas fa-plus-circle mr-3 text-lg"></i>Create Project</a></li>
                            </ul>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Communication</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-discussions"><i class="fas fa-comments mr-3 text-lg"></i>Discussions</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-messages"><i class="fas fa-envelope mr-3 text-lg"></i>Messages</a></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Tools</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-calendar"><i class="fas fa-calendar-alt mr-3 text-lg"></i>Calendar</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="student-analytics"><i class="fas fa-chart-line mr-3 text-lg"></i>Analytics</a></li>
                            </ul>
                        </div>
                    </div>

                    <div id="faculty-menu" style="display: none;">
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Dashboard</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200 active" data-section="faculty-dashboard" aria-current="page"><i class="fas fa-tachometer-alt mr-3 text-lg"></i>Overview</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-projects"><i class="fas fa-project-diagram mr-3 text-lg"></i>All Projects</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-students"><i class="fas fa-users mr-3 text-lg"></i>Students</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-approve-projects"><i class="fas fa-check-circle mr-3 text-lg"></i>Approve Projects</a></li>
                            </ul>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Management</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-create-project"><i class="fas fa-plus-circle mr-3 text-lg"></i>Create Project</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-submissions"><i class="fas fa-tasks mr-3 text-lg"></i>Review Submissions</a></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Reports</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-analytics"><i class="fas fa-chart-pie mr-3 text-lg"></i>Analytics</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="faculty-reports"><i class="fas fa-file-export mr-3 text-lg"></i>Export Data</a></li>
                            </ul>
                        </div>
                    </div>

                    <div id="admin-menu" style="display: none;">
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Dashboard</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200 active" data-section="admin-dashboard" aria-current="page"><i class="fas fa-tachometer-alt mr-3 text-lg"></i>System Overview</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-users"><i class="fas fa-users-cog mr-3 text-lg"></i>User Management</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-projects"><i class="fas fa-project-diagram mr-3 text-lg"></i>All Projects</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-submissions"><i class="fas fa-file-alt mr-3 text-lg"></i>All Submissions</a></li>
                            </ul>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">System Management</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-settings"><i class="fas fa-cogs mr-3 text-lg"></i>System Settings</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-logs"><i class="fas fa-clipboard-list mr-3 text-lg"></i>Activity Logs</a></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Reports & Analytics</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-analytics"><i class="fas fa-chart-bar mr-3 text-lg"></i>System Analytics</a></li>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-reports"><i class="fas fa-file-export mr-3 text-lg"></i>Generate Reports</a></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xs uppercase font-semibold text-gray-500 px-2 mb-3">Database Management</h3>
                            <ul>
                                <li><a href="#" class="sidebar-link flex items-center px-3 py-2 rounded-md text-gray-700 hover:bg-purple-50 hover:text-purple-700 active:bg-purple-100 transition-all duration-200" data-section="admin-database"><i class="fas fa-database mr-3 text-lg"></i>Database Manager</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            <div id="main-content-overlay" class="main-content-overlay md:hidden"></div>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <!-- Loading Indicator -->
                <div id="loading" class="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-40" style="display: none;" aria-live="polite" aria-busy="true">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
                </div>

                <!-- Student Dashboard -->
                <div id="student-dashboard" class="content-section">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">Student Dashboard</h2>
                        <div class="text-base text-gray-500">Welcome back, <span id="student-name" class="font-semibold text-purple-600"></span></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Total Projects</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="total-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600 text-xl">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Ongoing</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="ongoing-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600 text-xl">
                                    <i class="fas fa-spinner"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Submitted</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="submitted-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 text-xl">
                                    <i class="fas fa-file-upload"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Completed</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="completed-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600 text-xl">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6 lg:col-span-2 card-hover transition-all duration-300">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Project Progress</h3>
                            <div class="h-64">
                                <canvas id="progress-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Upcoming Deadlines</h3>
                            <div class="flex items-center justify-between mb-3">
                                <label for="deadline-sort" class="sr-only">Sort deadlines by</label>
                                <select id="deadline-sort" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-purple-500">
                                    <option value="date-asc">Date (Asc)</option>
                                    <option value="date-desc">Date (Desc)</option>
                                </select>
                            </div>
                            <div id="deadline-list" class="space-y-3">
                                <!-- Deadlines will be loaded here -->
                            </div>
                            <div id="no-deadlines" class="text-center py-10 text-gray-500">
                                <i class="fas fa-calendar-times text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No upcoming deadlines</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Activity</h3>
                        <div id="recent-activity" class="divide-y divide-gray-200">
                            <!-- Activity will be loaded here -->
                            <div class="text-center py-10 text-gray-500">
                                <i class="fas fa-history text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Projects -->
                <div id="student-projects" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">My Projects</h2>
                        <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
                            <input type="text" id="student-project-search" placeholder="Search projects..." class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Search my projects">
                            <select id="project-filter" class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-label="Filter my projects by status">
                                <option value="all">All Projects</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="submitted">Submitted</option>
                                <option value="completed">Completed</option>
                                <option value="pending_approval">Pending Approval</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visibility</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="project-list" class="bg-white divide-y divide-gray-200">
                                <!-- Projects will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No projects assigned</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Student Project Submission -->
                <div id="student-submissions" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Project Submissions</h2>
                        <p class="text-gray-600 text-lg">Submit your project work and track submission history</p>
                    </div>
                    <div id="submission-container">
                        <div class="text-center py-10 text-gray-500">
                            <i class="fas fa-info-circle text-4xl mb-3 text-gray-400"></i>
                            <p class="text-lg">Select a project to view and submit work</p>
                        </div>
                    </div>
                </div>

                <!-- Student Discussions -->
                <div id="student-discussions" class="content-section" style="display: none;">
                    <div class="mb-6 flex justify-between items-center">
                        <h2 class="text-3xl font-bold text-gray-800">Project Discussions</h2>
                        <button id="start-new-discussion-btn" class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">
                            <i class="fas fa-plus-circle mr-2"></i>Start New Discussion
                        </button>
                    </div>
                    <div id="discussions-container">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="text-center py-10 text-gray-500">
                                <i class="fas fa-comments text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No discussions yet. Start one with your faculty!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Claim Projects -->
                <div id="student-claim-projects" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Available Projects</h2>
                        <p class="text-gray-600 text-lg">Claim public projects to work on</p>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visibility</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="available-projects-list" class="bg-white divide-y divide-gray-200">
                                <!-- Projects will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No public projects available</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Student Messages -->
                <div id="student-messages" class="content-section" style="display: none;">
                    <div class="mb-6 flex justify-between items-center">
                        <h2 class="text-3xl font-bold text-gray-800">Messages</h2>
                        <button id="compose-new-message-btn" class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">
                            <i class="fas fa-envelope mr-2"></i>Compose New Message
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="border-b border-gray-200 pb-4 mb-4">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Inbox</h3>
                            <div class="relative">
                                <input type="text" id="message-search" placeholder="Search messages..." class="w-full p-3 pl-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-label="Search messages">
                                <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            </div>
                        </div>
                        <div id="message-list">
                            <div class="text-center py-10 text-gray-500">
                                <i class="fas fa-envelope-open-text text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No messages yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Create Project -->
                <div id="student-create-project" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Propose New Project</h2>
                        <p class="text-gray-600 text-lg">Propose a new project idea to a faculty supervisor</p>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <form id="student-new-project-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="student-project-title">Project Title</label>
                                <input type="text" id="student-project-title" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required placeholder="e.g., My Capstone Project Idea" aria-required="true">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="student-project-description">Description</label>
                                <textarea id="student-project-description" class="w-full p-3 border border-gray-300 rounded-md h-32 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required placeholder="Provide a detailed description of your project idea, objectives, and scope..." aria-required="true"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="student-project-deadline">Proposed Deadline</label>
                                    <input type="date" id="student-project-deadline" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required aria-required="true">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="student-project-faculty">Propose to Faculty Supervisor</label>
                                    <select id="student-project-faculty" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required aria-required="true">
                                        <option value="">Select Faculty Supervisor</option>
                                        <!-- Faculty will be loaded here by JS -->
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button type="reset" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">Clear Form</button>
                                <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                    <i class="fas fa-paper-plane mr-2"></i>Submit Proposal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Student Calendar -->
                <div id="student-calendar" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Project Calendar</h2>
                        <p class="text-gray-600 text-lg">View your project deadlines and schedule</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300" aria-label="Previous month"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-year" class="text-xl font-semibold text-gray-800"></h3>
                            <button id="next-month" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300" aria-label="Next month"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="calendar-grid" class="calendar-grid" role="grid">
                            <!-- Calendar days will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Student Analytics -->
                <div id="student-analytics" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Performance Analytics</h2>
                        <p class="text-gray-600 text-lg">Track your project performance and progress</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Submission History</h3>
                            <div class="chart-container">
                                <canvas id="submission-timeline" aria-label="Submission history chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Grade Distribution</h3>
                            <div class="chart-container">
                                <canvas id="grade-distribution" aria-label="Grade distribution chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Faculty Dashboard -->
                <div id="faculty-dashboard" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">Faculty Dashboard</h2>
                        <div class="text-base text-gray-500">Welcome back, <span id="faculty-name" class="font-semibold text-purple-600"></span></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Total Projects</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="faculty-total-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600 text-xl">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Ongoing</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="faculty-ongoing-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600 text-xl">
                                    <i class="fas fa-spinner"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Pending Review</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="faculty-pending-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 text-xl">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm text-gray-500">Completed</p>
                                    <h3 class="text-4xl font-bold text-gray-800 mt-1" id="faculty-completed-projects">0</h3>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600 text-xl">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6 lg:col-span-2 card-hover transition-all duration-300">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Project Distribution</h3>
                            <div class="h-64">
                                <canvas id="faculty-dashboard-chart" aria-label="Project distribution chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Submissions</h3>
                            <div id="recent-submissions" class="space-y-3">
                                <!-- Submissions will be loaded here -->
                            </div>
                            <div id="no-submissions" class="text-center py-10 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No recent submissions</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Urgent Deadlines</h3>
                        <div id="faculty-deadline-list" class="space-y-3">
                            <!-- Deadlines will be loaded here -->
                        </div>
                        <div id="no-faculty-deadlines" class="text-center py-10 text-gray-500">
                            <i class="fas fa-calendar-times text-4xl mb-3 text-gray-400"></i>
                            <p class="text-lg">No urgent deadlines</p>
                        </div>
                    </div>
                </div>

                <!-- Faculty Projects -->
                <div id="faculty-projects" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">All Projects</h2>
                        <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
                            <input type="text" id="project-search" placeholder="Search projects..." class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Search all projects">
                            <select id="faculty-project-filter" class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Filter all projects by status">
                                <option value="all">All Projects</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="submitted">Submitted</option>
                                <option value="completed">Completed</option>
                                <option value="pending_approval">Pending Approval</option>
                                <option value="rejected">Rejected</option>
                                <option value="open">Open (Public)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visibility</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="faculty-project-list" class="bg-white divide-y divide-gray-200">
                                <!-- Projects will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No projects created</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Faculty Students -->
                <div id="faculty-students" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">Student Directory</h2>
                        <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
                            <input type="text" id="student-directory-search" placeholder="Search students..." class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Search student directory">
                            <select id="student-directory-filter" class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-label="Filter student directory">
                                <option value="all">All Students</option>
                                <option value="active">Active Projects</option>
                                <option value="completed">Completed Projects</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projects</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Grade</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">On Time %</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-directory" class="bg-white divide-y divide-gray-200">
                                <!-- Students will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-user-graduate text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No students assigned</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Faculty Create Project -->
                <div id="faculty-create-project" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Create New Project</h2>
                        <p class="text-gray-600 text-lg">Assign a new project to one or more students</p>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <form id="new-project-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="project-title">Project Title</label>
                                <input type="text" id="project-title" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required placeholder="e.g., Advanced AI Research" aria-required="true">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="project-description">Description</label>
                                <textarea id="project-description" class="w-full p-3 border border-gray-300 rounded-md h-32 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required placeholder="Provide a detailed description of the project..." aria-required="true"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="project-visibility">Project Visibility</label>
                                    <select id="project-visibility" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-required="true">
                                        <option value="public">Public</option>
                                        <option value="private">Private (Only visible to assigned students)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="project-deadline">Deadline</label>
                                    <input type="date" id="project-deadline" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required aria-required="true">
                                </div>
                                <div id="private-assignment" style="display: none;">
                                    <label class="block text-gray-700 mb-2 font-medium" for="project-students">Assign To</label>
                                    <select id="project-students" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" multiple aria-label="Assign project to students">
                                        <!-- Students will be loaded here -->
                                    </select>
                                </div>
                                <div id="public-settings">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-2 font-medium" for="team-size">Team Size</label>
                                        <select id="team-size" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" aria-label="Select team size">
                                            <option value="1">1 (Individual)</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium">Resources (Optional)</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:bg-gray-50 transition-colors duration-200 cursor-pointer" onclick="document.getElementById('project-files').click()" role="button" tabindex="0" aria-label="Upload project files">
                                    <p class="text-sm text-gray-500 mb-2">Drag & drop files here or <span class="text-purple-600 font-semibold">click to browse</span></p>
                                    <input type="file" id="project-files" class="hidden" multiple aria-hidden="true">
                                    <div id="file-list" class="mt-3 text-sm text-gray-600">
                                        No files selected
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button type="button" id="cancel-project" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">Cancel</button>
                                <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                    <i class="fas fa-plus-circle mr-2"></i>Create Project
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Faculty Review Submissions -->
                <div id="faculty-submissions" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">Review Submissions</h2>
                        <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
                            <input type="text" id="submission-review-search" placeholder="Search submissions..." class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Search submissions to review">
                            <select id="submission-review-filter" class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Filter submissions to review">
                                <option value="pending_review">Pending Review</option>
                                <option value="reviewed">Reviewed</option>
                                <option value="all">All Submissions</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted On</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="submission-list" class="bg-white divide-y divide-gray-200">
                                <!-- Submissions will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-check-circle text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No submissions to review</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Faculty Analytics -->
                <div id="faculty-analytics" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Project Analytics</h2>
                        <p class="text-gray-600 text-lg">Track and analyze project progress and performance</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Status Distribution</h3>
                            <canvas id="faculty-status-chart" aria-label="Project status distribution chart"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Timeline Completion</h3>
                            <canvas id="faculty-timeline-chart" aria-label="Project timeline completion chart"></canvas>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Student Performance</h3>
                            <canvas id="faculty-performance-chart" aria-label="Student performance chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Faculty Approve Projects -->
                <div id="faculty-approve-projects" class="content-section" style="display: none;">
                    <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 md:mb-0">Approve Student Projects</h2>
                        <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 w-full md:w-auto">
                            <input type="text" id="approval-project-search" placeholder="Search proposals..." class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Search project proposals">
                            <select id="approval-project-filter" class="p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 w-full md:w-auto" aria-label="Filter project proposals">
                                <option value="pending_approval">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="all">All Proposals</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visibility</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approval-project-list" class="bg-white divide-y divide-gray-200">
                                <!-- Projects will be loaded here -->
                                <tr class="even:bg-gray-50">
                                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                                        <p class="text-lg">No projects pending approval</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Faculty Reports -->
                <div id="faculty-reports" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Export Reports</h2>
                        <p class="text-gray-600 text-lg">Generate and download project reports</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Project Status Report</h3>
                                    <p class="text-sm text-gray-600 mb-4">Summary of all projects with current status</p>
                                </div>
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600 text-xl">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                            </div>
                            <button class="w-full mt-4 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                <i class="fas fa-download mr-2"></i>Export as PDF
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Grade Report</h3>
                                    <p class="text-sm text-gray-600 mb-4">Grades for all completed projects</p>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600 text-xl">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <button class="w-full mt-4 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                <i class="fas fa-download mr-2"></i>Export as Excel
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-300">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Student Performance</h3>
                                    <p class="text-sm text-gray-600 mb-4">Detailed performance analysis by student</p>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600 text-xl">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                            </div>
                            <button class="w-full mt-4 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                <i class="fas fa-download mr-2"></i>Export as CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Dashboard -->
                <div id="admin-dashboard" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">System Overview</h2>
                        <p class="text-gray-600 text-lg">Monitor and manage the entire project management system</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Users</p>
                                    <p class="text-3xl font-bold text-gray-900" id="admin-total-users">0</p>
                                </div>
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Active Projects</p>
                                    <p class="text-3xl font-bold text-gray-900" id="admin-active-projects">0</p>
                                </div>
                                <div class="p-3 bg-green-100 rounded-full">
                                    <i class="fas fa-project-diagram text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Pending Approvals</p>
                                    <p class="text-3xl font-bold text-gray-900" id="admin-pending-approvals">0</p>
                                </div>
                                <div class="p-3 bg-yellow-100 rounded-full">
                                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Submissions</p>
                                    <p class="text-3xl font-bold text-gray-900" id="admin-total-submissions">0</p>
                                </div>
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">User Distribution</h3>
                            <div class="chart-container">
                                <canvas id="admin-user-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                            <div class="chart-container">
                                <canvas id="admin-activity-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin User Management -->
                <div id="admin-users" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">User Management</h2>
                        <p class="text-gray-600 text-lg">Manage users, roles, and permissions</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" id="admin-user-search" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <select id="admin-role-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">All Roles</option>
                                        <option value="student">Students</option>
                                        <option value="faculty">Faculty</option>
                                        <option value="admin">Admins</option>
                                    </select>
                                </div>
                                <div>
                                    <button onclick="showAddUserModal()" class="px-6 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
                                        <i class="fas fa-plus mr-2"></i>Add User
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projects</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-users-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex items-center justify-center">
                                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mr-2"></div>
                                                Loading users...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Logs -->
                <div id="admin-logs" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Activity Logs</h2>
                        <p class="text-gray-600 text-lg">Monitor system activity and user actions</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" placeholder="Search logs..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <select class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">All Actions</option>
                                        <option value="login">Login</option>
                                        <option value="project_created">Project Created</option>
                                        <option value="submission">Submission</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="space-y-4" id="admin-logs-list">
                                <div class="flex items-center justify-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mr-3"></div>
                                    <span class="text-gray-600">Loading activity logs...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Analytics -->
                <div id="admin-analytics" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">System Analytics</h2>
                        <p class="text-gray-600 text-lg">Comprehensive analytics and insights</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Project Status Distribution</h3>
                            <div class="chart-container">
                                <canvas id="admin-project-status-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">User Activity Trends</h3>
                            <div class="chart-container">
                                <canvas id="admin-monthly-trends-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Metrics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600" id="admin-avg-completion-time">0</div>
                                <div class="text-sm text-gray-600">Avg. Completion Time (Days)</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600" id="admin-success-rate">0%</div>
                                <div class="text-sm text-gray-600">Project Success Rate</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-purple-600" id="admin-user-engagement">0%</div>
                                <div class="text-sm text-gray-600">User Engagement Rate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Settings -->
                <div id="admin-settings" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">System Settings</h2>
                        <p class="text-gray-600 text-lg">Configure system preferences and settings</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-2 bg-blue-100 rounded-lg mr-3">
                                    <i class="fas fa-cog text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">General Settings</h3>
                            </div>
                            <p class="text-gray-600 mb-4">Configure general system settings and preferences</p>
                            <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">
                                Configure Settings
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-2 bg-green-100 rounded-lg mr-3">
                                    <i class="fas fa-database text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Database Management</h3>
                            </div>
                            <p class="text-gray-600 mb-4">Manage database backups and maintenance</p>
                            <button class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200">
                                Manage Database
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                                    <i class="fas fa-shield-alt text-yellow-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Security Settings</h3>
                            </div>
                            <p class="text-gray-600 mb-4">Configure security policies and access controls</p>
                            <button class="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors duration-200">
                                Security Settings
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-2 bg-purple-100 rounded-lg mr-3">
                                    <i class="fas fa-chart-bar text-purple-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">Performance Report</h3>
                            </div>
                            <p class="text-gray-600 mb-4">System performance and usage analytics</p>
                            <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin All Projects -->
                <div id="admin-projects" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">All Projects</h2>
                        <p class="text-gray-600 text-lg">Overview of all projects in the system</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" id="admin-project-search" placeholder="Search projects..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <select id="admin-project-status-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">All Status</option>
                                        <option value="ongoing">Ongoing</option>
                                        <option value="completed">Completed</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-projects-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex items-center justify-center">
                                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mr-2"></div>
                                                Loading projects...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin All Submissions -->
                <div id="admin-submissions" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">All Submissions</h2>
                        <p class="text-gray-600 text-lg">Monitor all project submissions across the system</p>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" id="admin-submission-search" placeholder="Search submissions..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <select id="admin-submission-status-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">All Status</option>
                                        <option value="pending">Pending Review</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submission</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-submissions-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                            <div class="flex items-center justify-center">
                                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mr-2"></div>
                                                Loading submissions...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Generate Reports -->
                <div id="admin-reports" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Generate Reports</h2>
                        <p class="text-gray-600 text-lg">Create and export system reports</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-blue-100 rounded-lg mr-4">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">User Report</h3>
                                    <p class="text-sm text-gray-600">All users and their details</p>
                                </div>
                            </div>
                            <button onclick="generateReport('users')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-green-100 rounded-lg mr-4">
                                    <i class="fas fa-project-diagram text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Projects Report</h3>
                                    <p class="text-sm text-gray-600">All projects and status</p>
                                </div>
                            </div>
                            <button onclick="generateReport('projects')" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-purple-100 rounded-lg mr-4">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Submissions Report</h3>
                                    <p class="text-sm text-gray-600">All submissions and grades</p>
                                </div>
                            </div>
                            <button onclick="generateReport('submissions')" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-yellow-100 rounded-lg mr-4">
                                    <i class="fas fa-chart-line text-yellow-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Analytics Report</h3>
                                    <p class="text-sm text-gray-600">System performance metrics</p>
                                </div>
                            </div>
                            <button onclick="generateReport('analytics')" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-red-100 rounded-lg mr-4">
                                    <i class="fas fa-clipboard-list text-red-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Activity Report</h3>
                                    <p class="text-sm text-gray-600">System activity logs</p>
                                </div>
                            </div>
                            <button onclick="generateReport('activity')" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center mb-4">
                                <div class="p-3 bg-gray-100 rounded-lg mr-4">
                                    <i class="fas fa-file-export text-gray-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Custom Report</h3>
                                    <p class="text-sm text-gray-600">Create custom reports</p>
                                </div>
                            </div>
                            <button onclick="generateReport('custom')" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors duration-200">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Database Manager -->
                <div id="admin-database" class="content-section" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Database Manager</h2>
                        <p class="text-gray-600 text-lg">View and manage database records</p>
                    </div>

                    <!-- Database Tables -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Users</h3>
                                <i class="fas fa-users text-2xl text-blue-500"></i>
                            </div>
                            <p class="text-gray-600 mb-4">Manage user accounts and profiles</p>
                            <button onclick="loadDatabaseTable('users')" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                View Users
                            </button>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Projects</h3>
                                <i class="fas fa-project-diagram text-2xl text-green-500"></i>
                            </div>
                            <p class="text-gray-600 mb-4">Manage project records and data</p>
                            <button onclick="loadDatabaseTable('projects')" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                View Projects
                            </button>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Submissions</h3>
                                <i class="fas fa-file-upload text-2xl text-purple-500"></i>
                            </div>
                            <p class="text-gray-600 mb-4">Manage submission records</p>
                            <button onclick="loadDatabaseTable('submissions')" class="w-full bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors">
                                View Submissions
                            </button>
                        </div>
                    </div>

                    <!-- Database Table View -->
                    <div id="database-table-container" class="bg-white rounded-lg shadow" style="display: none;">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 id="database-table-title" class="text-xl font-semibold text-gray-800">Database Records</h3>
                                <div class="flex space-x-2">
                                    <button onclick="refreshDatabaseTable()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                                    </button>
                                    <button onclick="closeDatabaseTable()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Close
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-4">
                                <input type="text" id="database-search" placeholder="Search records..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead id="database-table-header" class="bg-gray-50">
                                        <!-- Headers will be loaded dynamically -->
                                    </thead>
                                    <tbody id="database-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Data will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="database-no-data" class="text-center py-10 text-gray-500" style="display: none;">
                                <i class="fas fa-database text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg">No records found</p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Notification Dropdown -->
    <div id="notification-dropdown" class="fixed right-4 top-20 bg-white rounded-lg shadow-lg z-50 w-72 hidden" role="menu" aria-labelledby="notification-btn">
        <div class="p-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-800">Notifications</h3>
        </div>
        <div class="divide-y divide-gray-200 max-h-60 overflow-y-auto" id="notification-list">
            <div class="p-3 hover:bg-gray-50">
                <p class="text-sm text-gray-800">No new notifications</p>
            </div>
        </div>
        <div class="p-3 text-center text-sm text-blue-600 hover:bg-gray-50 cursor-pointer">
            View All Notifications
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="modal-project-title">
        <div class="bg-white rounded-lg p-8 w-full max-w-4xl max-h-screen overflow-y-auto shadow-xl transition-all duration-300 ease-out modal-content-animated">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modal-project-title">Project Title</h2>
                <button id="close-project-modal" class="text-gray-500 hover:text-gray-700 text-xl" aria-label="Close project details modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6 pb-4 border-b border-gray-200">
                <div class="flex flex-wrap items-center space-x-4 mb-2">
                    <span class="px-3 py-1 rounded-full text-xs font-medium" id="modal-project-status">In Progress</span>
                    <span class="px-3 py-1 rounded-full text-xs font-medium" id="modal-project-visibility"></span>
                    <span class="text-sm text-gray-500"><i class="fas fa-calendar-alt mr-1"></i> <span id="modal-project-deadline">Due: 2023-12-31</span></span>
                </div>
                <p class="text-gray-700 text-base" id="modal-project-description">Project description goes here.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Project Details</h3>
                    <div class="space-y-2 text-gray-700">
                        <div>
                            <span class="text-sm text-gray-500 block">Assigned To:</span>
                            <p class="font-medium" id="modal-project-student">Loading...</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500 block">Supervisor:</span>
                            <p class="font-medium" id="modal-project-faculty">Loading...</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Resources</h3>
                    <div id="modal-project-resources" class="space-y-2">
                        <!-- Resources will be loaded here -->
                        <p class="text-gray-500 italic text-sm">No resources provided</p>
                    </div>
                </div>
            </div>
            
            <div id="submission-tab-group">
                <div class="flex border-b border-gray-200 mb-6" role="tablist">
                    <button class="submission-tab active px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600 transition-colors duration-200" data-tab="submissions" role="tab" aria-selected="true" aria-controls="submissions-tab">Submissions</button>
                    <button class="submission-tab px-4 py-2 font-medium text-gray-500 hover:text-purple-600 transition-colors duration-200" data-tab="discussion" role="tab" aria-selected="false" aria-controls="discussion-tab">Discussion</button>
                    <button class="submission-tab px-4 py-2 font-medium text-gray-500 hover:text-purple-600 transition-colors duration-200" data-tab="feedback" role="tab" aria-selected="false" aria-controls="feedback-tab">Feedback</button>
                </div>
                
                <div id="submissions-tab" class="tab-content" role="tabpanel" aria-labelledby="submissions-tab">
                    <div id="submission-history" class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Submission History</h4>
                        <!-- Submission history will be loaded here -->
                        <p class="text-gray-500 italic text-center py-4">No submissions yet</p>
                    </div>
                    
                    <div id="student-submission-form" class="mt-8 border-t border-gray-200 pt-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Submit Your Work</h4>
                        <form id="new-submission-form" enctype="multipart/form-data">
                            <div class="mb-4">
                                <input type="file" id="submission-files" name="files" class="hidden" multiple aria-hidden="true">
                                <button type="button" onclick="document.getElementById('submission-files').click()" class="w-full border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:bg-gray-50 transition-colors duration-200 cursor-pointer" role="button" aria-label="Select files for submission">
                                    <div class="flex flex-col items-center justify-center">
                                        <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
                                        <p class="text-base text-gray-500">Click to select files or drag and drop</p>
                                        <p class="text-sm text-gray-400 mt-1">PDF, Word, ZIP, Images (Max 10MB per file)</p>
                                    </div>
                                </button>
                                <div id="submission-file-list" class="mt-3 text-sm text-gray-600">
                                    <p>No files selected</p>
                                </div>
                                <div id="submission-file-preview" class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <!-- File previews will be loaded here -->
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="submission-notes">Notes (Optional)</label>
                                <textarea id="submission-notes" class="w-full p-3 border border-gray-300 rounded-md h-24 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Add any additional notes for your submission..."></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                    <i class="fas fa-paper-plane mr-2"></i>Submit
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="faculty-feedback-form" class="mt-8 border-t border-gray-200 pt-6" style="display: none;">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Provide Feedback</h4>
                        <form id="new-feedback-form">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2 font-medium" for="feedback-text">Comments</label>
                                <textarea id="feedback-text" class="w-full p-3 border border-gray-300 rounded-md h-24 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Enter your feedback..." required aria-required="true"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="feedback-grade">Grade (out of 100)</label>
                                    <input type="number" id="feedback-grade" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" min="0" max="100" step="1" placeholder="e.g., 85">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2 font-medium" for="feedback-status">Project Status</label>
                                    <select id="feedback-status" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200">
                                        <option value="submitted">Submitted (Needs Review)</option>
                                        <option value="ongoing">Ongoing</option>
                                        <option value="completed">Mark Complete</option>
                                        <option value="rejected">Reject</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                    <i class="fas fa-check mr-2"></i>Submit Feedback
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="discussion-tab" class="tab-content" style="display: none;" role="tabpanel" aria-labelledby="discussion-tab">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Project Discussion</h4>
                        <div id="discussion-thread" class="space-y-4 bg-gray-50 p-4 rounded-md max-h-80 overflow-y-auto">
                            <!-- Discussion messages will be loaded here -->
                            <p class="text-gray-500 italic text-center py-4">No discussion yet. Start a conversation!</p>
                        </div>
                        <form id="new-comment-form" class="mt-6">
                            <div class="flex space-x-3">
                                <input type="text" id="comment-text" class="flex-1 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Add a comment..." required aria-required="true">
                                <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="feedback-tab" class="tab-content" style="display: none;" role="tabpanel" aria-labelledby="feedback-tab">
                    <div id="feedback-content" class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Feedback History</h4>
                        <!-- Feedback will be loaded here -->
                        <p class="text-gray-500 italic text-center py-4">No feedback yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Claim Preview Modal -->
    <div id="claim-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="claim-preview-title">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl max-h-screen overflow-y-auto shadow-xl transition-all duration-300 ease-out modal-content-animated">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="claim-preview-title">Project Preview</h2>
                <button id="close-claim-preview-modal" class="text-gray-500 hover:text-gray-700 text-xl" aria-label="Close project preview modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6 pb-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-2" id="claim-preview-project-title"></h3>
                <div class="flex flex-wrap items-center space-x-4 mb-2">
                    <span class="px-3 py-1 rounded-full text-xs font-medium" id="claim-preview-status"></span>
                    <span class="px-3 py-1 rounded-full text-xs font-medium" id="claim-preview-visibility"></span>
                    <span class="text-sm text-gray-500"><i class="fas fa-user-tie mr-1"></i> Faculty: <span id="claim-preview-faculty-name"></span></span>
                    <span class="text-sm text-gray-500"><i class="fas fa-calendar-alt mr-1"></i> Due: <span id="claim-preview-deadline"></span></span>
                </div>
                <p class="text-gray-700 text-base" id="claim-preview-description"></p>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Team Size</h3>
                <p class="text-gray-700" id="claim-preview-team-size"></p>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="confirm-claim-btn" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                    <i class="fas fa-hand-sparkles mr-2"></i>Confirm Claim
                </button>
            </div>
        </div>
    </div>

    <!-- Compose Message Modal -->
    <div id="compose-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="compose-message-title">
        <div class="bg-white rounded-lg p-8 w-full max-w-md shadow-xl transition-all duration-300 ease-out modal-content-animated">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="compose-message-title">Compose New Message</h2>
                <button id="close-compose-message-modal" class="text-gray-500 hover:text-gray-700 text-xl" aria-label="Close compose message modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="compose-message-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="message-recipient">Recipient</label>
                    <select id="message-recipient" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required aria-required="true">
                        <option value="">Select Recipient</option>
                        <!-- Recipients will be loaded here -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="message-subject">Subject</label>
                    <input type="text" id="message-subject" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Message subject" required aria-required="true">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="message-body">Message</label>
                    <textarea id="message-body" class="w-full p-3 border border-gray-300 rounded-md h-32 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Your message..." required aria-required="true"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-5 py-2.5 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-lg active:scale-98 transition-all duration-200 font-semibold">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student Profile Modal (New, Reused Element) -->
    <div id="student-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="student-profile-title">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl shadow-xl transition-all duration-300 ease-out modal-content-animated">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="student-profile-title">Student Profile: Loading...</h2>
                <button id="close-student-profile-modal" class="text-gray-500 hover:text-gray-700 text-xl" aria-label="Close student profile modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-500">Username</p>
                    <p class="font-medium text-gray-800" id="student-profile-username">Loading...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-500">Projects</p>
                    <p class="font-medium text-gray-800" id="student-profile-projects-count">Loading...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-500">Average Grade</p>
                    <p class="font-medium text-gray-800" id="student-profile-avg-grade">Loading...</p>
                </div>
            </div>
            
            <div class="mb-6 bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Performance Overview</h3>
                <canvas id="student-performance-chart" height="150" aria-label="Student performance chart"></canvas>
            </div>
            
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Recent Projects</h3>
                <div id="student-profile-recent-projects" class="space-y-3">
                    <p class="text-gray-500 italic text-center py-4">Loading projects...</p>
                </div>
            </div>
            
            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">System Overview</h2>
            <p class="text-gray-600 text-lg">Monitor and manage the entire project management system</p>
        </div>
        
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Users</p>
                        <p class="text-3xl font-bold text-gray-900" id="admin-total-users">0</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Projects</p>
                        <p class="text-3xl font-bold text-gray-900" id="admin-active-projects">0</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-full">
                        <i class="fas fa-project-diagram text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pending Approvals</p>
                        <p class="text-3xl font-bold text-gray-900" id="admin-pending-approvals">0</p>
                    </div>
                    <div class="p-3 bg-yellow-100 rounded-full">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Submissions</p>
                        <p class="text-3xl font-bold text-gray-900" id="admin-total-submissions">0</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-file-upload text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">System Activity</h3>
                <div class="chart-container">
                    <canvas id="admin-activity-chart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">User Distribution</h3>
                <div class="chart-container">
                    <canvas id="admin-user-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin User Management -->
    <div id="admin-users" class="content-section" style="display: none;">
        <div class="mb-6 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">User Management</h2>
                <p class="text-gray-600 text-lg">Manage all system users and their roles</p>
            </div>
            <button id="add-user-btn" class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">
                <i class="fas fa-user-plus mr-2"></i>Add New User
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="admin-user-search" placeholder="Search users..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <select id="admin-user-role-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">All Roles</option>
                            <option value="student">Students</option>
                            <option value="faculty">Faculty</option>
                            <option value="admin">Admins</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projects</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-users-list" class="bg-white divide-y divide-gray-200">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Projects -->
    <div id="admin-projects" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">All Projects</h2>
            <p class="text-gray-600 text-lg">Overview of all projects in the system</p>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="admin-project-search" placeholder="Search projects..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <select id="admin-project-status-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">All Status</option>
                            <option value="open">Open</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="pending_approval">Pending Approval</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-projects-list" class="bg-white divide-y divide-gray-200">
                    <!-- Projects will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Submissions -->
    <div id="admin-submissions" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">All Submissions</h2>
            <p class="text-gray-600 text-lg">Monitor all project submissions across the system</p>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="admin-submission-search" placeholder="Search submissions..." class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <select id="admin-submission-status-filter" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">All Status</option>
                            <option value="pending_review">Pending Review</option>
                            <option value="reviewed">Reviewed</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-submissions-list" class="bg-white divide-y divide-gray-200">
                    <!-- Submissions will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Settings -->
    <div id="admin-settings" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">System Settings</h2>
            <p class="text-gray-600 text-lg">Configure system-wide settings and preferences</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">General Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">System Name</label>
                        <input type="text" value="College Project Management" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Project Deadline (Days)</label>
                        <input type="number" value="30" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">Allow student self-registration</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Email Notifications</h3>
                <div class="space-y-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">Project deadline reminders</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">New submission notifications</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">System maintenance alerts</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button class="px-6 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 font-semibold">
                Save Settings
            </button>
        </div>
    </div>


    <!-- Admin Analytics -->
    <div id="admin-analytics" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">System Analytics</h2>
            <p class="text-gray-600 text-lg">Comprehensive analytics and insights</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Project Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="admin-project-status-chart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">User Activity Trends</h3>
                <div class="chart-container">
                    <canvas id="admin-monthly-trends-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="admin-avg-completion-time">0</div>
                    <div class="text-sm text-gray-600">Avg. Completion Time (Days)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="admin-success-rate">0%</div>
                    <div class="text-sm text-gray-600">Project Success Rate</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="admin-user-engagement">0%</div>
                    <div class="text-sm text-gray-600">User Engagement Rate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Reports -->
    <div id="admin-reports" class="content-section" style="display: none;">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Generate Reports</h2>
            <p class="text-gray-600 text-lg">Create and export system reports</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-blue-100 rounded-full mr-4">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">User Report</h3>
                </div>
                <p class="text-gray-600 mb-4">Comprehensive user activity and statistics</p>
                <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">
                    Generate Report
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-green-100 rounded-full mr-4">
                        <i class="fas fa-project-diagram text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Project Report</h3>
                </div>
                <p class="text-gray-600 mb-4">Project status, completion rates, and trends</p>
                <button class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200">
                    Generate Report
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-purple-100 rounded-full mr-4">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Performance Report</h3>
                </div>
                <p class="text-gray-600 mb-4">System performance and usage analytics</p>
                <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors duration-200">
                    Generate Report
                </button>
            </div>
        </div>
    </div>


    <script>
     // Base URL for your API
const API_BASE_URL = window.location.origin; // Use the current origin for API calls

// Current logged-in user (will be populated after successful login from backend)
let currentUser = null;
let userToken = localStorage.getItem('userToken'); // Retrieve token on load

// Add event listeners when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => {
    // Login form submission
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            await loginUser(email, password, role);
        });
    }

    // Register form submission
    const registerBtn = document.getElementById('register-btn');
    if (registerBtn) {
        registerBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            
            if (!name || !email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            await registerUser(name, email, password, role);
        });
    }

    // Toggle between login and register forms
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');

    if (loginTab && registerTab && loginForm && registerForm) {
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.style.display = 'block';
            loginForm.style.display = 'none';
        });
    }
});
let currentSubmissionIdForFeedback = null; // Global variable to store submission ID for feedback form

// Helper functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function getStatusBadge(status) {
    const statusMap = {
        'ongoing': { text: 'Ongoing', color: 'bg-blue-100 text-blue-800' },
        'submitted': { text: 'Submitted', color: 'bg-yellow-100 text-yellow-800' },
        'completed': { text: 'Completed', color: 'bg-green-100 text-green-800' },
        'pending_approval': { text: 'Pending Approval', color: 'bg-purple-100 text-purple-800' },
        'rejected': { text: 'Rejected', color: 'bg-red-100 text-red-800' },
        'open': { text: 'Open', color: 'bg-gray-200 text-gray-800' },
        'private': { text: 'Private', color: 'bg-gray-300 text-gray-800' },
        'public': { text: 'Public', color: 'bg-blue-200 text-blue-800' },
        'pending_review': { text: 'Pending Review', color: 'bg-yellow-100 text-yellow-800' },
        'reviewed': { text: 'Reviewed', color: 'bg-green-100 text-green-800' },
        'loading': { text: 'Loading...', color: 'bg-gray-100 text-gray-500' }
    };
    const statusInfo = statusMap[status] || { text: status, color: 'bg-gray-100 text-gray-800' };
    return `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusInfo.color}">${statusInfo.text}</span>`;
}

// Custom fetch wrapper to include JWT token and handle 401
async function authenticatedFetch(url, options = {}) {
    if (!userToken) {
        logoutUser();
        throw new Error('No authentication token');
    }
    
    const headers = {
        ...options.headers,
        'Authorization': `Bearer ${userToken}`
    };
    
    try {
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
            alert('Session expired. Please login again.');
            logoutUser();
            throw new Error('Unauthorized');
        }
        
        return response;
    } catch (error) {
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            alert('Network error. Please check your connection.');
        }
        throw error;
    }
}

// DOM elements
const authModal = document.getElementById('auth-modal');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const appContainer = document.getElementById('app');
const loadingIndicator = document.getElementById('loading');
const currentUserElement = document.getElementById('current-user');
const userRoleElement = document.getElementById('user-role');
const studentMenu = document.getElementById('student-menu');
const facultyMenu = document.getElementById('faculty-menu');
const sidebarLinks = document.querySelectorAll('.sidebar-link');
const contentSections = document.querySelectorAll('.content-section');
const logoutBtn = document.getElementById('logout-btn');
const notificationDropdown = document.getElementById('notification-dropdown');
const notificationList = document.getElementById('notification-list');
const themeToggleBtn = document.getElementById('theme-toggle');
const sidebarToggleBtn = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const mainContentOverlay = document.getElementById('main-content-overlay');

// Notification dropdown toggle
document.getElementById('notification-btn').addEventListener('click', async (e) => {
    e.stopPropagation();
    notificationDropdown.classList.toggle('hidden');
    if (!notificationDropdown.classList.contains('hidden')) {
        await loadNotifications();
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    const notifBtn = document.getElementById('notification-btn');
    if (!notificationDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notificationDropdown.classList.add('hidden');
    }
});

// Event Listeners for Auth Modal
document.getElementById('login-tab').addEventListener('click', () => {
    document.getElementById('login-tab').classList.add('border-purple-600', 'text-purple-600');
    document.getElementById('login-tab').setAttribute('aria-selected', 'true');
    document.getElementById('register-tab').classList.remove('border-purple-600', 'text-purple-600');
    document.getElementById('register-tab').classList.add('text-gray-500');
    document.getElementById('register-tab').setAttribute('aria-selected', 'false');
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
});

document.getElementById('register-tab').addEventListener('click', () => {
    document.getElementById('register-tab').classList.add('border-purple-600', 'text-purple-600');
    document.getElementById('register-tab').setAttribute('aria-selected', 'true');
    document.getElementById('login-tab').classList.remove('border-purple-600', 'text-purple-600');
    document.getElementById('login-tab').classList.add('text-gray-500');
    document.getElementById('login-tab').setAttribute('aria-selected', 'false');
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
});

document.getElementById('close-auth').addEventListener('click', () => {
    authModal.querySelector('.modal-content-animated').classList.remove('show');
    setTimeout(() => {
        authModal.style.display = 'none';
    }, 300);
});

document.getElementById('login-btn').addEventListener('click', async (e) => {
    e.preventDefault(); // Prevent default form submission
    const username = document.getElementById('login-username').value; // This is email for backend
    const password = document.getElementById('login-password').value;
    const role = document.getElementById('login-role').value; // Role is not directly used by backend /auth/login, but needed for frontend logic
    await loginUser(username, password, role);
});

document.getElementById('logout-btn').addEventListener('click', logoutUser);

document.getElementById('register-btn').addEventListener('click', async (e) => {
    e.preventDefault(); // Prevent default form submission
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const name = document.getElementById('register-name').value;
    const role = document.getElementById('register-role').value;
    await registerUser(name, email, password, role);
});

// Sidebar navigation
sidebarLinks.forEach(link => {
    link.addEventListener('click', async (e) => {
        e.preventDefault();

        sidebarLinks.forEach(l => {
            l.classList.remove('active', 'text-purple-700', 'bg-purple-50');
            l.classList.add('text-gray-700');
            l.removeAttribute('aria-current');
        });

        link.classList.add('active', 'text-purple-700', 'bg-purple-50');
        link.classList.remove('text-gray-700');
        link.setAttribute('aria-current', 'page');

        // Smooth transition for content sections
        const currentActiveSection = document.querySelector('.content-section.active');
        if (currentActiveSection) {
            currentActiveSection.classList.remove('active');
        }

        const sectionId = link.getAttribute('data-section');
        const targetSection = document.getElementById(sectionId);

        // Hide all sections first
        contentSections.forEach(section => {
            section.style.display = 'none';
        });

        // Show target section and apply active class for transition
        targetSection.style.display = 'block';
        setTimeout(() => {
            targetSection.classList.add('active');
        }, 10); // Small delay to allow display:block to apply before transition

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('open');
            mainContentOverlay.classList.remove('active');
        }

        await loadSectionData(sectionId);
    });
});

// Mobile sidebar toggle
sidebarToggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    mainContentOverlay.classList.toggle('active');
});

mainContentOverlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    mainContentOverlay.classList.remove('active');
});

// Authentication functions
async function loginUser(username, password, role) {
    showLoading();
    try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password,
                role: role
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Login failed');
        }

        userToken = data.access_token;
        localStorage.setItem('userToken', data.access_token);
        localStorage.setItem('access_token', data.access_token);
        
        console.log('Login successful! Token:', userToken);
        console.log('User data:', data.user);
        
        currentUser = {
            id: data.user.id,
            name: data.user.name,
            email: data.user.email,
            role: data.user.role
        };

        hideLoading();
        
        // Close auth modal
        const authModal = document.getElementById('auth-modal');
        const modalContent = authModal.querySelector('.modal-content-animated');
        modalContent.classList.remove('show');
        
        setTimeout(() => {
            authModal.style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // Show success message
            alert('Login successful!');
            
            // Initialize the app with the logged-in user
            if (typeof initializeApp === 'function') {
                initializeApp();
            }
        }, 300);
        
    } catch (error) {
        console.error('Login error:', error);
        hideLoading();
        alert(error.message || 'An error occurred during login. Please try again.');
    }
}

async function registerUser(name, email, password, role) {
    showLoading();
    try {
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                email: email,
                password: password,
                role: role
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Registration failed');
        }

        // Auto-login after successful registration
        await loginUser(email, password, role);
        
    } catch (error) {
        console.error('Registration error:', error);
        hideLoading();
        alert(error.message || 'An error occurred during registration. Please try again.');
    }
}

function logoutUser() {
    currentUser = null;
    userToken = null;
    localStorage.removeItem('userToken');
    appContainer.style.display = 'none';
    authModal.style.display = 'flex';
    authModal.querySelector('.modal-content-animated').classList.add('show');
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-username').value = '';
    document.getElementById('login-password').value = '';
    // Reset sidebar active state
    sidebarLinks.forEach(l => {
        l.classList.remove('active', 'text-purple-700', 'bg-purple-50');
        l.removeAttribute('aria-current');
    });
    // Hide all content sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
        section.classList.remove('active');
    });
    destroyAllCharts();
}

function destroyAllCharts() {
    const chartInstances = [
        'studentProgressChartInstance',
        'submissionTimelineChartInstance', 
        'gradeDistributionChartInstance',
        'facultyDashboardChartInstance',
        'facultyStatusChartInstance',
        'facultyTimelineChartInstance',
        'facultyPerformanceChartInstance',
        'studentProfileChartInstance'
    ];
    
    chartInstances.forEach(instanceName => {
        if (window[instanceName]) {
            window[instanceName].destroy();
            window[instanceName] = null;
        }
    });
}

function showLoading() {
    loadingIndicator.style.display = 'flex';
    loadingIndicator.setAttribute('aria-busy', 'true');
}

function hideLoading() {
    loadingIndicator.style.display = 'none';
    loadingIndicator.setAttribute('aria-busy', 'false');
}

// Initialize the app after successful login
async function initializeApp() {
    if (!userToken) {
        logoutUser();
        return;
    }

    // Attempt to get user info from token if not already set (e.g., on page refresh)
    if (!currentUser) {
        try {
            const base64Url = userToken.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedToken = JSON.parse(atob(base64));
            currentUser = {
                id: decodedToken.id,
                name: decodedToken.name,
                email: decodedToken.sub,
                role: decodedToken.role
            };
        } catch (e) {
            console.error("Failed to decode token or token is invalid:", e);
            logoutUser();
            return;
        }
    }

    currentUserElement.textContent = currentUser.name;
    userRoleElement.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

    // Hide all menus first
    studentMenu.style.display = 'none';
    facultyMenu.style.display = 'none';
    const adminMenu = document.getElementById('admin-menu');
    if (adminMenu) adminMenu.style.display = 'none';

    // Reset active sidebar link
    sidebarLinks.forEach(l => {
        l.classList.remove('active', 'text-purple-700', 'bg-purple-50');
        l.classList.add('text-gray-700');
        l.removeAttribute('aria-current');
    });

    // Hide all content sections
    contentSections.forEach(section => {
        section.style.display = 'none';
        section.classList.remove('active');
    });

    if (currentUser.role === 'student') {
        studentMenu.style.display = 'block';
        const studentDashboardLink = document.querySelector('.sidebar-link[data-section="student-dashboard"]');
        if (studentDashboardLink) {
            studentDashboardLink.classList.add('active', 'text-purple-700', 'bg-purple-50');
            studentDashboardLink.setAttribute('aria-current', 'page');
            document.getElementById('student-dashboard').style.display = 'block';
            document.getElementById('student-dashboard').classList.add('active');
            await loadSectionData('student-dashboard');
        }
    } else if (currentUser.role === 'faculty') {
        facultyMenu.style.display = 'block';
        const facultyDashboardLink = document.querySelector('.sidebar-link[data-section="faculty-dashboard"]');
        if (facultyDashboardLink) {
            facultyDashboardLink.classList.add('active', 'text-purple-700', 'bg-purple-50');
            facultyDashboardLink.setAttribute('aria-current', 'page');
            document.getElementById('faculty-dashboard').style.display = 'block';
            document.getElementById('faculty-dashboard').classList.add('active');
            await loadSectionData('faculty-dashboard');
        }
    } else if (currentUser.role === 'admin') {
        console.log('Setting up admin user interface...');
        adminMenu.style.display = 'block';
        
        // Hide all other sections first
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
            section.classList.remove('active');
        });
        
        // Force show admin dashboard
        const adminDashboardSection = document.getElementById('admin-dashboard');
        if (adminDashboardSection) {
            adminDashboardSection.style.display = 'block';
            adminDashboardSection.classList.add('active');
            console.log('Initializing admin dashboard...');
            await loadAdminDashboard();
        }
        
        // Set active link
        const adminDashboardLink = document.querySelector('.sidebar-link[data-section="admin-dashboard"]');
        if (adminDashboardLink) {
            // Remove active from all links first
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active', 'text-purple-700', 'bg-purple-50');
                link.removeAttribute('aria-current');
            });
            
            adminDashboardLink.classList.add('active', 'text-purple-700', 'bg-purple-50');
            adminDashboardLink.setAttribute('aria-current', 'page');
        }
        
        // Load admin data immediately with fallback
        setTimeout(async () => {
            console.log('Loading admin dashboard with sample data...');
            await loadAdminDashboard();
            
            // Force load sample data for all admin sections
            const adminStatsElements = {
                'admin-total-users': '10',
                'admin-total-projects': '4', 
                'admin-active-projects': '2',
                'admin-total-submissions': '8'
            };
            
            Object.entries(adminStatsElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
            
            // Ensure user management shows data
            loadAdminUsers();
        }, 100);
    } else {
        // Handle other roles or default to a view
        alert("Unsupported user role. Logging out.");
        logoutUser();
        return;
    }
    await loadNotifications();
}

// Load data for each section when clicked
async function loadSectionData(sectionId) {
    showLoading();
    try {
        if (sectionId === 'student-dashboard') {
            await loadStudentDashboard();
        } else if (sectionId === 'student-projects') {
            await loadStudentProjects();
            document.getElementById('project-filter').onchange = () => loadStudentProjects();
            document.getElementById('student-project-search').onkeyup = () => loadStudentProjects();
        } else if (sectionId === 'student-claim-projects') {
            await loadAvailableProjects();
        } else if (sectionId === 'student-submissions') {
            await loadStudentSubmissions();
        } else if (sectionId === 'student-discussions') {
            await loadStudentDiscussions();
        } else if (sectionId === 'student-messages') {
            await loadStudentMessages();
        } else if (sectionId === 'student-create-project') {
            await loadStudentCreateProject();
        } else if (sectionId === 'student-calendar') {
            await loadStudentCalendar();
        } else if (sectionId === 'student-analytics') {
            await loadStudentAnalytics();
        } else if (sectionId === 'faculty-dashboard') {
            await loadFacultyDashboard();
        } else if (sectionId === 'faculty-projects') {
            await loadFacultyProjects();
            document.getElementById('faculty-project-filter').onchange = () => loadFacultyProjects();
            document.getElementById('project-search').onkeyup = () => loadFacultyProjects();
        } else if (sectionId === 'faculty-submissions') {
            await loadFacultySubmissions();
            document.getElementById('submission-review-filter').onchange = () => loadFacultySubmissions();
            document.getElementById('submission-review-search').onkeyup = () => loadFacultySubmissions();
        } else if (sectionId === 'faculty-students') {
            await loadFacultyStudents();
            document.getElementById('student-directory-filter').onchange = () => loadFacultyStudents();
            document.getElementById('student-directory-search').onkeyup = () => loadFacultyStudents();
        } else if (sectionId === 'faculty-create-project') {
            await loadFacultyCreateProject();
        } else if (sectionId === 'faculty-analytics') {
            await loadFacultyAnalytics();
        } else if (sectionId === 'faculty-approve-projects') {
            await loadFacultyApproveProjects();
            document.getElementById('approval-project-filter').onchange = () => loadFacultyApproveProjects();
            document.getElementById('approval-project-search').onkeyup = () => loadFacultyApproveProjects();
        } else if (sectionId === 'admin-dashboard') {
            console.log('Loading admin dashboard section...');
            await loadAdminDashboard();
        } else if (sectionId === 'admin-users') {
            console.log('Loading admin users section...');
            setTimeout(async () => {
                await loadAdminUsers();
                const searchEl = document.getElementById('admin-user-search');
                const filterEl = document.getElementById('admin-role-filter');
                if (searchEl) {
                    searchEl.addEventListener('input', () => loadAdminUsers());
                    searchEl.addEventListener('keyup', () => loadAdminUsers());
                }
                if (filterEl) {
                    filterEl.addEventListener('change', () => loadAdminUsers());
                }
            }, 50);
        } else if (sectionId === 'admin-projects') {
            console.log('Loading admin projects section...');
            setTimeout(async () => {
                await loadAdminProjects();
                const searchEl = document.getElementById('admin-project-search');
                const filterEl = document.getElementById('admin-project-status-filter');
                if (searchEl) searchEl.addEventListener('input', () => loadAdminProjects());
                if (filterEl) filterEl.addEventListener('change', () => loadAdminProjects());
            }, 50);
        } else if (sectionId === 'admin-submissions') {
            console.log('Loading admin submissions section...');
            setTimeout(async () => {
                await loadAdminSubmissions();
                const searchEl = document.getElementById('admin-submission-search');
                const filterEl = document.getElementById('admin-submission-status-filter');
                if (searchEl) searchEl.addEventListener('input', () => loadAdminSubmissions());
                if (filterEl) filterEl.addEventListener('change', () => loadAdminSubmissions());
            }, 50);
        } else if (sectionId === 'admin-reports') {
            console.log('Loading admin reports section...');
            setTimeout(() => {
                loadAdminReports();
            }, 50);
        } else if (sectionId === 'admin-settings') {
            console.log('Loading admin settings section...');
            setTimeout(() => {
                loadAdminSettings();
            }, 50);
        } else if (sectionId === 'admin-logs') {
            console.log('Loading admin logs section...');
            setTimeout(() => {
                loadAdminLogs();
            }, 50);
        } else if (sectionId === 'admin-analytics') {
            console.log('Loading admin analytics section...');
            setTimeout(async () => {
                await loadAdminAnalytics();
            }, 50);
        } else if (sectionId === 'admin-reports') {
            console.log('Loading admin reports section...');
            setTimeout(() => {
                loadAdminReports();
            }, 50);
        } else if (sectionId === 'faculty-reports') {
            loadFacultyReports();
        } else if (sectionId === 'admin-analytics') {
            await loadAdminAnalytics();
        } else if (sectionId === 'faculty-approve-projects') {
            await loadFacultyApproveProjects();
            document.getElementById('approval-project-filter').onchange = () => loadFacultyApproveProjects();
            document.getElementById('approval-project-search').onkeyup = () => loadFacultyApproveProjects();
        } else if (sectionId === 'admin-reports') {
            loadAdminReports();
        } else if (sectionId === 'admin-logs') {
            loadAdminLogs();
        } else if (sectionId === 'admin-dashboard') {
            console.log('Loading admin dashboard section...');
            await loadAdminDashboard();
        } else if (sectionId === 'admin-users') {
            console.log('Loading admin users section...');
            setTimeout(async () => {
                await loadAdminUsers();
                const searchEl = document.getElementById('admin-user-search');
                const filterEl = document.getElementById('admin-role-filter');
                if (searchEl) {
                    searchEl.addEventListener('input', () => loadAdminUsers());
                    searchEl.addEventListener('keyup', () => loadAdminUsers());
                }
                if (filterEl) {
                    filterEl.addEventListener('change', () => loadAdminUsers());
                }
            }, 50);
        } else if (sectionId === 'admin-projects') {
            console.log('Loading admin projects section...');
            setTimeout(async () => {
                await loadAdminProjects();
                const searchEl = document.getElementById('admin-project-search');
                const filterEl = document.getElementById('admin-project-status-filter');
                if (searchEl) searchEl.addEventListener('input', () => loadAdminProjects());
                if (filterEl) filterEl.addEventListener('change', () => loadAdminProjects());
            }, 50);
        } else if (sectionId === 'admin-submissions') {
            console.log('Loading admin submissions section...');
            setTimeout(async () => {
                await loadAdminSubmissions();
                const searchEl = document.getElementById('admin-submission-search');
                const filterEl = document.getElementById('admin-submission-status-filter');
                if (searchEl) searchEl.addEventListener('input', () => loadAdminSubmissions());
                if (filterEl) filterEl.addEventListener('change', () => loadAdminSubmissions());
            }, 50);
        } else if (sectionId === 'admin-reports') {
            console.log('Loading admin reports section...');
            setTimeout(() => {
                loadAdminReports();
            }, 50);
        } else if (sectionId === 'admin-settings') {
            console.log('Loading admin settings section...');
            setTimeout(() => {
                loadAdminSettings();
            }, 50);
        } else if (sectionId === 'admin-logs') {
            console.log('Loading admin logs section...');
            setTimeout(() => {
                loadAdminLogs();
            }, 50);
        } else if (sectionId === 'admin-analytics') {
            console.log('Loading admin analytics section...');
            setTimeout(async () => {
                await loadAdminAnalytics();
            }, 50);
        } else if (sectionId === 'admin-reports') {
            console.log('Loading admin reports section...');
            setTimeout(() => {
                loadAdminReports();
            }, 50);
        }
    } catch (error) {
        console.error(`Error loading section ${sectionId}:`, error);
        if (error.message !== "Unauthorized") {
            alert(`Failed to load data for ${sectionId}. Please try again.`);
        }
    } finally {
        hideLoading();
    }
}

// Notifications
async function loadNotifications() {
    // This endpoint is not provided in the backend, so it remains a placeholder.
    // In a real app, you'd fetch notifications for the current user.
    console.log("Loading notifications (placeholder).");
    notificationList.innerHTML = `
        <div class="p-3 text-center text-gray-500">
            <p class="text-sm">No new notifications (API not implemented)</p>
        </div>
    `;
    document.getElementById('notification-btn').querySelector('span').style.display = 'none'; // Hide bell icon
}

// Student Dashboard
let studentProgressChartInstance = null;

async function loadStudentDashboard() {
    document.getElementById('student-name').textContent = currentUser.name;

    try {
        // Fetch actual project data instead of analytics
        const projectsResponse = await authenticatedFetch(`${API_BASE_URL}/projects?assigned_to=${currentUser.id}`);
        const submissionsResponse = await authenticatedFetch(`${API_BASE_URL}/submissions?student_id=${currentUser.id}`);
        
        if (!projectsResponse.ok || !submissionsResponse.ok) {
            throw new Error('Failed to fetch project data');
        }
        
        const projects = await projectsResponse.json();
        const submissions = await submissionsResponse.json();

        // Calculate actual project statistics
        const totalProjects = projects.length;
        const ongoingProjects = projects.filter(p => p.status === 'in_progress' || p.status === 'assigned').length;
        const submittedProjects = submissions.filter(s => s.status === 'submitted' || s.status === 'graded').length;
        const completedProjects = projects.filter(p => p.status === 'completed').length;

        // Update dashboard with real data
        document.getElementById('total-projects').textContent = totalProjects;
        document.getElementById('ongoing-projects').textContent = ongoingProjects;
        document.getElementById('submitted-projects').textContent = submittedProjects;
        document.getElementById('completed-projects').textContent = completedProjects;

        const progressCtx = document.getElementById('progress-chart').getContext('2d');
        if (studentProgressChartInstance) {
            studentProgressChartInstance.destroy();
        }

        studentProgressChartInstance = new Chart(progressCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Submitted', 'Ongoing', 'Available'],
                datasets: [{
                    data: [completedProjects, submittedProjects, ongoingProjects, Math.max(0, totalProjects - completedProjects - submittedProjects - ongoingProjects)],
                    backgroundColor: ['#10B981', '#FBBF24', '#3B82F6', '#A78BFA'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 14 } } },
                    tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed}` } }
                }
            }
        });

        const deadlineList = document.getElementById('deadline-list');
        const noDeadlines = document.getElementById('no-deadlines');
        const deadlineSort = document.getElementById('deadline-sort');

        // Load upcoming deadlines from actual projects
        const upcomingDeadlines = projects
            .filter(p => p.deadline && new Date(p.deadline) > new Date())
            .map(p => ({
                title: p.title,
                deadline: p.deadline,
                status: p.status,
                priority: p.priority || 'medium'
            }))
            .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
            .slice(0, 5);

        const renderDeadlines = (deadlines, sortOrder) => {
            let sortedDeadlines = [...deadlines];
            if (sortOrder === 'date-asc') {
                sortedDeadlines.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            } else if (sortOrder === 'date-desc') {
                sortedDeadlines.sort((a, b) => new Date(b.deadline) - new Date(a.deadline));
            }

            if (sortedDeadlines && sortedDeadlines.length > 0) {
                noDeadlines.style.display = 'none';
                deadlineList.innerHTML = '';

                sortedDeadlines.forEach(project => {
                    const daysLeft = Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    const deadlineItem = document.createElement('div');
                    deadlineItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                    deadlineItem.innerHTML = `
                        <div>
                            <h4 class="font-medium text-gray-800">${project.title}</h4>
                            <p class="text-sm text-gray-500">Supervisor: ${project.faculty_name || 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium ${daysLeft <= 3 ? 'text-red-600' : 'text-gray-600'}">
                                ${formatDate(project.deadline)}
                            </p>
                            <p class="text-xs ${daysLeft <= 3 ? 'text-red-500' : 'text-gray-500'}">
                                ${daysLeft > 0 ? `${daysLeft} days left` : 'Due today'}
                            </p>
                        </div>
                    `;
                    deadlineList.appendChild(deadlineItem);
                });
            } else {
                deadlineList.innerHTML = '';
                noDeadlines.style.display = 'block';
            }
        };

        renderDeadlines(upcomingDeadlines, 'date-asc');
        deadlineSort.addEventListener('change', () => renderDeadlines(upcomingDeadlines, deadlineSort.value));

        // Load recent activity from actual submissions and projects
        const recentActivity = [];
        
        // Add recent submissions
        submissions.slice(0, 3).forEach(sub => {
            recentActivity.push({
                icon: 'fa-file-upload',
                title: `Submitted ${sub.title || 'project'}`,
                time: new Date(sub.submitted_at || sub.created_at).toLocaleDateString(),
                type: 'submission'
            });
        });
        
        // Add recent project updates
        projects.slice(0, 2).forEach(proj => {
            recentActivity.push({
                icon: 'fa-project-diagram',
                title: `Working on ${proj.title}`,
                time: new Date(proj.updated_at || proj.created_at).toLocaleDateString(),
                type: 'project'
            });
        });
        
        recentActivity.sort((a, b) => new Date(b.time) - new Date(a.time));

        const activityList = document.getElementById('recent-activity');
        if (recentActivity.length > 0) {
            activityList.innerHTML = '';
            recentActivity.slice(0, 5).forEach(act => {
                const activityItem = document.createElement('div');
                activityItem.className = 'py-3 flex items-start';
                activityItem.innerHTML = `
                    <div class="p-2 rounded-full bg-purple-100 text-purple-600 mr-3 text-lg">
                        <i class="fas ${act.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-800 font-medium">${act.title}</p>
                        <p class="text-xs text-gray-500">${act.time}</p>
                    </div>
                `;
                activityList.appendChild(activityItem);
            });
        } else {
            activityList.innerHTML = `
                <div class="text-center py-10 text-gray-500">
                    <i class="fas fa-history text-4xl mb-3 text-gray-400"></i>
                    <p class="text-lg">No recent activity</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading student dashboard:', error);
        // Set default values on error
        document.getElementById('total-projects').textContent = '0';
        document.getElementById('ongoing-projects').textContent = '0';
        document.getElementById('submitted-projects').textContent = '0';
        document.getElementById('completed-projects').textContent = '0';
        
        // Show error message to user
        showNotification('Failed to load dashboard data. Please refresh the page.', 'error');
        document.getElementById('completed-projects').textContent = '0';
        if (studentProgressChartInstance) studentProgressChartInstance.destroy();
        document.getElementById('deadline-list').innerHTML = '';
        document.getElementById('no-deadlines').style.display = 'block';
        document.getElementById('recent-activity').innerHTML = `
            <div class="text-center py-10 text-gray-500">
                <i class="fas fa-history text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Failed to load activity.</p>
            </div>
        `;
    }
}

// Student Projects
async function loadStudentProjects() {
    const filter = document.getElementById('project-filter').value;
    const search = document.getElementById('student-project-search').value.toLowerCase();
    const projectList = document.getElementById('project-list');
    projectList.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading projects...</p>
            </td>
        </tr>
    `;

    try {
        const statusQuery = filter === 'all' ? '' : `&status=${filter}`;
        const searchQuery = search ? `&search=${search}` : '';
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?assigned_to=${currentUser.id}${statusQuery}${searchQuery}`);
        let projects = await response.json();

        if (projects.length > 0) {
            projectList.innerHTML = '';
            projects.forEach((project, index) => {
                const daysLeft = project.deadline ? Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : 'N/A';
                const deadlineText = daysLeft === 'N/A' ? 'N/A' : (daysLeft > 0 ? `${daysLeft} days left` : (daysLeft === 0 ? 'Due today' : 'Overdue'));
                const deadlineClass = daysLeft === 'N/A' ? '' : (daysLeft <= 3 && daysLeft >= 0 ? 'text-red-500 font-semibold' : (daysLeft < 0 ? 'text-red-700 font-semibold' : ''));

                const projectRow = document.createElement('tr');
                projectRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                projectRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${project.title}</div>
                                <div class="text-sm text-gray-500">${project.description.substring(0, 50)}${project.description.length > 50 ? '...' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${project.faculty_name || 'N/A'}</div>
                        <div class="text-xs text-gray-500">Faculty</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.visibility)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(project.deadline)}</div>
                        <div class="text-xs text-gray-500 ${deadlineClass}">
                            ${deadlineText}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-purple-600 hover:text-purple-900 view-project active:scale-95 transition-all duration-150" data-id="${project.id}" aria-label="View details for ${project.title}">View Details</button>
                    </td>
                `;
                projectList.appendChild(projectRow);
            });

            document.querySelectorAll('#project-list .view-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await openProjectModal(projectId);
                });
            });
        } else {
            projectList.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No projects assigned</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading student projects:', error);
        projectList.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="6" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load projects.</p>
                </td>
            </tr>
        `;
    }
}

// Student Claim Projects
async function loadAvailableProjects() {
    const projectList = document.getElementById('available-projects-list');
    projectList.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading available projects...</p>
            </td>
        </tr>
    `;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?visibility=public&status=open`);
        let availableProjects = await response.json();

        // Filter out projects already claimed by the current user
        availableProjects = availableProjects.filter(p => !p.student_ids.includes(currentUser.id));

        if (availableProjects.length > 0) {
            projectList.innerHTML = '';
            availableProjects.forEach((project, index) => {
                const daysLeft = project.deadline ? Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : 'N/A';
                const projectRow = document.createElement('tr');
                projectRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                projectRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${project.title}</div>
                                <div class="text-sm text-gray-500">${project.description.substring(0, 50)}${project.description.length > 50 ? '...' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${project.faculty_name || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.visibility)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(project.deadline)}</div>
                        <div class="text-xs text-gray-500 ${daysLeft <= 7 ? 'text-red-500' : ''}">
                            ${daysLeft > 0 ? `${daysLeft} days left` : 'Due today'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 claim-project-preview active:scale-98 transition-all duration-200 font-semibold" data-id="${project.id}" aria-label="Preview and claim ${project.title}">
                            Preview & Claim
                        </button>
                    </td>
                `;
                projectList.appendChild(projectRow);
            });

            document.querySelectorAll('.claim-project-preview').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = btn.getAttribute('data-id');
                    await openClaimPreviewModal(projectId);
                });
            });
        } else {
            projectList.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No public projects available</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading available projects:', error);
        projectList.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="6" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load available projects.</p>
                </td>
            </tr>
        `;
    }
}

// Project Claim Preview Modal
const claimPreviewModal = document.getElementById('claim-preview-modal');
const closeClaimPreviewModalBtn = document.getElementById('close-claim-preview-modal');
const confirmClaimBtn = document.getElementById('confirm-claim-btn');
let currentProjectToClaim = null;

closeClaimPreviewModalBtn.addEventListener('click', () => {
    claimPreviewModal.querySelector('.modal-content-animated').classList.remove('show');
    setTimeout(() => {
        claimPreviewModal.style.display = 'none';
    }, 300);
});

async function openClaimPreviewModal(projectId) {
    claimPreviewModal.style.display = 'flex';
    setTimeout(() => {
        claimPreviewModal.querySelector('.modal-content-animated').classList.add('show');
    }, 10);

    document.getElementById('claim-preview-project-title').textContent = 'Loading...';
    document.getElementById('claim-preview-faculty-name').textContent = 'Loading...';
    document.getElementById('claim-preview-deadline').textContent = 'Loading...';
    document.getElementById('claim-preview-description').textContent = 'Loading...';
    document.getElementById('claim-preview-team-size').textContent = 'Loading...';
    document.getElementById('claim-preview-status').innerHTML = getStatusBadge('loading');
    document.getElementById('claim-preview-visibility').innerHTML = getStatusBadge('loading');
    confirmClaimBtn.disabled = true;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects/${projectId}`);
        const project = await response.json();
        currentProjectToClaim = project;

        document.getElementById('claim-preview-project-title').textContent = project.title;
        document.getElementById('claim-preview-faculty-name').textContent = project.faculty_name || 'N/A';
        document.getElementById('claim-preview-deadline').textContent = formatDate(project.deadline);
        document.getElementById('claim-preview-description').textContent = project.description;
        document.getElementById('claim-preview-team-size').textContent = project.team_size ? `${project.team_size} student(s)` : 'Not specified';
        document.getElementById('claim-preview-status').innerHTML = getStatusBadge(project.status);
        document.getElementById('claim-preview-visibility').innerHTML = getStatusBadge(project.visibility);
        confirmClaimBtn.disabled = false;

    } catch (error) {
        console.error('Error loading project preview:', error);
        alert('Failed to load project preview. Please try again.');
        claimPreviewModal.querySelector('.modal-content-animated').classList.remove('show');
        setTimeout(() => { claimPreviewModal.style.display = 'none'; }, 300);
    }
}

confirmClaimBtn.addEventListener('click', async () => {
    if (currentProjectToClaim) {
        await claimProject(currentProjectToClaim.id);
        claimPreviewModal.querySelector('.modal-content-animated').classList.remove('show');
        setTimeout(() => { claimPreviewModal.style.display = 'none'; }, 300);
    }
});

async function claimProject(projectId) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects/${projectId}/claim`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('Project claimed successfully! It is now in "My Projects".');
            await loadAvailableProjects(); // Refresh available projects
            document.querySelector('.sidebar-link[data-section="student-projects"]').click(); // Navigate to My Projects
        } else {
            const errorData = await response.json();
            alert(`Failed to claim project: ${errorData.detail || 'An error occurred.'}`);
        }
    } catch (error) {
        console.error('Error claiming project:', error);
        alert('An error occurred while claiming the project. Please try again.');
    }
}

// Student Submissions
async function loadStudentSubmissions() {
    const container = document.getElementById('submission-container');
    container.innerHTML = `
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center py-10 text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading projects for submission...</p>
            </div>
        </div>
    `;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?assigned_to=${currentUser.id}&status=ongoing,submitted`);
        const projects = await response.json();

        if (projects.length > 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Select a Project to Submit Work</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        ${projects.map(project => `
                            <div class="p-4 hover:bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center transition-colors duration-200">
                                <div class="mb-2 md:mb-0">
                                    <h4 class="font-medium text-gray-800 text-lg">${project.title}</h4>
                                    <p class="text-sm text-gray-500">${getStatusBadge(project.status)} ${getStatusBadge(project.visibility)} • Due: ${formatDate(project.deadline)}</p>
                                </div>
                                <button class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 submit-btn font-semibold" data-id="${project.id}" aria-label="Submit work for ${project.title}">
                                    Submit Work
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.querySelectorAll('.submit-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await openProjectModal(projectId, 'submissions');
                });
            });
        } else {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No projects assigned to submit work for.</p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading student submissions:', error);
        container.innerHTML = `
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center py-10 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load projects for submission.</p>
                </div>
            </div>
        `;
    }
}

// Student Create Project
async function loadStudentCreateProject() {
    const facultySelect = document.getElementById('student-project-faculty');
    facultySelect.innerHTML = '<option value="">Loading faculty...</option>';

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users?role=faculty`);
        const facultyUsers = await response.json();

        facultySelect.innerHTML = '<option value="">Select Faculty Supervisor</option>';
        facultyUsers.forEach(faculty => {
            const option = document.createElement('option');
            option.value = faculty.id;
            option.textContent = faculty.name;
            facultySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading faculty for project creation:', error);
        facultySelect.innerHTML = '<option value="">Failed to load faculty</option>';
        alert('Failed to load faculty supervisors.');
    }

    const studentNewProjectForm = document.getElementById('student-new-project-form');
    studentNewProjectForm.onsubmit = async function(e) {
        e.preventDefault();

        const title = document.getElementById('student-project-title').value;
        const description = document.getElementById('student-project-description').value;
        const deadline = document.getElementById('student-project-deadline').value;
        const facultyId = document.getElementById('student-project-faculty').value;

        if (!title.trim() || !description.trim() || !deadline || !facultyId) {
            alert('Please fill in all required fields and select a faculty supervisor.');
            return;
        }

        if (title.length < 3) {
            alert('Project title must be at least 3 characters long.');
            return;
        }

        if (description.length < 10) {
            alert('Project description must be at least 10 characters long.');
            return;
        }

        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/projects`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    description,
                    faculty_id: facultyId,
                    deadline,
                    visibility: 'private',
                    status: 'pending_approval'
                })
            });

            if (response.ok) {
                alert('Project proposal submitted successfully!');
                studentNewProjectForm.reset();
                document.querySelector('.sidebar-link[data-section="student-projects"]').click();
            } else {
                const errorData = await response.json();
                alert(`Failed to submit proposal: ${errorData.detail || 'An error occurred.'}`);
            }
        } catch (error) {
            console.error('Error submitting project proposal:', error);
            alert('An error occurred while submitting your proposal. Please try again.');
        }
    };
}

// Student Discussions (Main Section)
async function loadStudentDiscussions() {
    const discussionsContainer = document.getElementById('discussions-container');
    discussionsContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center py-10 text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading projects for discussions...</p>
            </div>
        </div>
    `;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?assigned_to=${currentUser.id}`);
        const projects = await response.json();

        if (projects.length > 0) {
            discussionsContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800">Select a Project to View Discussions</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        ${projects.map(project => `
                            <div class="p-4 hover:bg-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center transition-colors duration-200">
                                <div class="mb-2 md:mb-0">
                                    <h4 class="font-medium text-gray-800 text-lg">${project.title}</h4>
                                    <p class="text-sm text-gray-500">Supervisor: ${project.faculty_name || 'N/A'}</p>
                                </div>
                                <button class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90 hover:shadow-md active:scale-98 transition-all duration-200 view-discussion-btn font-semibold" data-id="${project.id}" aria-label="View discussion for ${project.title}">
                                    View Discussion
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.querySelectorAll('.view-discussion-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await openProjectModal(projectId, 'discussion');
                });
            });

            document.getElementById('start-new-discussion-btn').onclick = () => {
                alert('To start a new discussion, please select an existing project from the list below and use its "View Discussion" option.');
            };

        } else {
            discussionsContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-comments text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No projects assigned to view discussions for.</p>
                    </div>
                </div>
            `;
            document.getElementById('start-new-discussion-btn').onclick = () => {
                alert('You need to have an assigned project to start a discussion.');
            };
        }
    } catch (error) {
        console.error('Error loading student discussions:', error);
        discussionsContainer.innerHTML = `
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center py-10 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load discussions.</p>
                </div>
            </div>
        `;
    }
}

// Student Messages (Main Section)
async function loadStudentMessages() {
    const messageListDiv = document.getElementById('message-list');
    const messageSearchInput = document.getElementById('message-search');

    messageListDiv.innerHTML = `
        <div class="text-center py-10 text-gray-500">
            <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
            <p class="text-lg">Loading messages...</p>
        </div>
    `;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/messages?search=${messageSearchInput.value.toLowerCase()}`);
        const allMessages = await response.json();

        const renderMessages = (messages) => {
            if (messages.length > 0) {
                messageListDiv.innerHTML = '';
                messages.forEach(message => {
                    const isSent = message.sender_id === currentUser.id;

                    const messageItem = document.createElement('div');
                    messageItem.className = `p-4 border-b border-gray-200 ${isSent ? 'bg-blue-50' : 'bg-gray-50'} hover:bg-gray-100 cursor-pointer`;
                    messageItem.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-800">${isSent ? `To: ${message.recipient_name}` : `From: ${message.sender_name}`}</span>
                            <span class="text-xs text-gray-500">${formatDateTime(message.timestamp)}</span>
                        </div>
                        <h4 class="text-base font-medium text-gray-700">${message.subject}</h4>
                        <p class="text-sm text-gray-600 truncate">${message.body}</p>
                    `;
                    messageListDiv.appendChild(messageItem);
                });
            } else {
                messageListDiv.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-envelope-open-text text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No messages found matching your criteria.</p>
                    </div>
                `;
            }
        };

        renderMessages(allMessages);
        messageSearchInput.onkeyup = async () => {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/messages?search=${messageSearchInput.value.toLowerCase()}`);
                const filteredMessages = await response.json();
                renderMessages(filteredMessages);
            } catch (error) {
                console.error('Error searching messages:', error);
                alert('Failed to search messages.');
            }
        };

        document.getElementById('compose-new-message-btn').addEventListener('click', async () => {
            await openComposeMessageModal();
        });
    } catch (error) {
        console.error('Error loading student messages:', error);
        messageListDiv.innerHTML = `
            <div class="text-center py-10 text-red-500">
                <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                <p class="text-lg">Failed to load messages.</p>
            </div>
        `;
    }
}

// Compose Message Modal
const composeMessageModal = document.getElementById('compose-message-modal');
const closeComposeMessageModalBtn = document.getElementById('close-compose-message-modal');
const composeMessageForm = document.getElementById('compose-message-form');
const messageRecipientSelect = document.getElementById('message-recipient');

closeComposeMessageModalBtn.addEventListener('click', () => {
    composeMessageModal.querySelector('.modal-content-animated').classList.remove('show');
    setTimeout(() => {
        composeMessageModal.style.display = 'none';
        composeMessageForm.reset();
    }, 300);
});

async function openComposeMessageModal() {
    messageRecipientSelect.innerHTML = '<option value="">Loading recipients...</option>';
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users`);
        const users = await response.json();

        messageRecipientSelect.innerHTML = '<option value="">Select Recipient</option>';
        users.forEach(user => {
            if (user.id !== currentUser.id) { // Don't allow sending messages to self
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.role})`;
                messageRecipientSelect.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading message recipients:', error);
        messageRecipientSelect.innerHTML = '<option value="">Failed to load recipients</option>';
        alert('Failed to load message recipients.');
    }

    composeMessageModal.style.display = 'flex';
    setTimeout(() => {
        composeMessageModal.querySelector('.modal-content-animated').classList.add('show');
    }, 10);
}

composeMessageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const recipientId = messageRecipientSelect.value;
    const subject = document.getElementById('message-subject').value;
    const body = document.getElementById('message-body').value;

    if (!recipientId || !subject.trim() || !body.trim()) {
        alert('Please fill in all message fields.');
        return;
    }

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ recipient_id: recipientId, subject, body })
        });

        if (response.ok) {
            alert('Message sent successfully!');
            composeMessageModal.querySelector('.modal-content-animated').classList.remove('show');
            setTimeout(async () => {
                composeMessageModal.style.display = 'none';
                composeMessageForm.reset();
                await loadStudentMessages(); // Refresh messages list
            }, 300);
        } else {
            const errorData = await response.json();
            alert(`Failed to send message: ${errorData.detail || 'An error occurred.'}`);
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('An error occurred while sending your message. Please try again.');
    }
});

// Student Calendar
let currentCalendarDate = new Date();

async function loadStudentCalendar() {
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');

    // Prevent duplicate calendar loading
    if (calendarGrid.children.length > 0) {
        return; // Calendar already loaded
    }

    currentMonthYear.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    calendarGrid.innerHTML = '';

    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    daysOfWeek.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        calendarGrid.appendChild(header);
    });

    const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
    }

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?assigned_to=${currentUser.id}`);
        const projects = await response.json();
        const projectDeadlines = projects.map(p => ({ date: p.deadline, title: p.title }));

        for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const date = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day current-month`;
            if (date.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = day;
            dayElement.appendChild(dayNumber);

            projectDeadlines.forEach(event => {
                if (new Date(event.date).toDateString() === date.toDateString()) {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event deadline';
                    eventDiv.textContent = event.title;
                    dayElement.appendChild(eventDiv);
                }
            });

            calendarGrid.appendChild(dayElement);
        }

        const totalDays = firstDayOfMonth.getDay() + lastDayOfMonth.getDate();
        const remainingCells = 42 - totalDays;
        for (let i = 0; i < remainingCells; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day other-month';
            calendarGrid.appendChild(emptyDay);
        }
    } catch (error) {
        console.error('Error loading student calendar:', error);
        calendarGrid.innerHTML = `
            <div class="col-span-7 text-center py-10 text-red-500">
                <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                <p class="text-lg">Failed to load calendar events.</p>
            </div>
        `;
    }
}

document.getElementById('prev-month').addEventListener('click', async () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = ''; // Clear before reload
    await loadStudentCalendar();
});

document.getElementById('next-month').addEventListener('click', async () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = ''; // Clear before reload
    await loadStudentCalendar();
});

// Student Analytics
let submissionTimelineChartInstance = null;
let gradeDistributionChartInstance = null;

async function loadStudentAnalytics() {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/analytics/student`);
        const analyticsData = await response.json();

        // Submission History Chart
        const submissionLabels = analyticsData.submission_history.map(item => item.date);
        const submissionData = analyticsData.submission_history.map(item => item.count);

        const submissionTimelineCtx = document.getElementById('submission-timeline').getContext('2d');
        if (submissionTimelineChartInstance) {
            submissionTimelineChartInstance.destroy();
        }
        submissionTimelineChartInstance = new Chart(submissionTimelineCtx, {
            type: 'line',
            data: {
                labels: submissionLabels,
                datasets: [{
                    label: 'Number of Submissions',
                    data: submissionData,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Submissions' } },
                    x: { title: { display: true, text: 'Month' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Grade Distribution Chart
        const gradeLabels = Object.keys(analyticsData.grade_distribution);
        const gradeData = Object.values(analyticsData.grade_distribution);

        const gradeDistributionCtx = document.getElementById('grade-distribution').getContext('2d');
        if (gradeDistributionChartInstance) {
            gradeDistributionChartInstance.destroy();
        }
        gradeDistributionChartInstance = new Chart(gradeDistributionCtx, {
            type: 'bar',
            data: {
                labels: gradeLabels,
                datasets: [{
                    label: 'Number of Projects',
                    data: gradeData,
                    backgroundColor: ['#10B981', '#3B82F6', '#FBBF24', '#EF4444', '#6B7280'],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Number of Projects' } },
                    x: { title: { display: true, text: 'Grade Range' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    } catch (error) {
        console.error('Error loading student analytics:', error);
        alert('Failed to load student analytics data.');
        // Clear charts on error
        if (submissionTimelineChartInstance) submissionTimelineChartInstance.destroy();
        if (gradeDistributionChartInstance) gradeDistributionChartInstance.destroy();
    }
}

// Faculty Dashboard
let facultyDashboardChartInstance = null;

async function loadFacultyDashboard() {
    document.getElementById('faculty-name').textContent = currentUser.name;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/analytics/faculty`);
        const dashboardData = await response.json();

        document.getElementById('faculty-total-projects').textContent = dashboardData.total_projects;
        document.getElementById('faculty-ongoing-projects').textContent = dashboardData.ongoing_projects;
        document.getElementById('faculty-pending-projects').textContent = dashboardData.pending_review_submissions;
        document.getElementById('faculty-completed-projects').textContent = dashboardData.completed_projects;

        const facultyDashboardCtx = document.getElementById('faculty-dashboard-chart').getContext('2d');
        if (facultyDashboardChartInstance) {
            facultyDashboardChartInstance.destroy();
        }

        facultyDashboardChartInstance = new Chart(facultyDashboardCtx, {
            type: 'doughnut',
            data: {
                labels: ['Ongoing', 'Submitted', 'Completed', 'Pending Approval', 'Rejected', 'Open'],
                datasets: [{
                    data: [
                        dashboardData.status_counts.ongoing || 0,
                        dashboardData.status_counts.submitted || 0,
                        dashboardData.status_counts.completed || 0,
                        dashboardData.status_counts.pending_approval || 0,
                        dashboardData.status_counts.rejected || 0,
                        dashboardData.status_counts.open || 0
                    ],
                    backgroundColor: ['#3B82F6', '#FBBF24', '#10B981', '#A78BFA', '#EF4444', '#6B7280'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 14 } } },
                    tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed}` } }
                }
            }
        });

        const submissionsList = document.getElementById('recent-submissions');
        const noSubmissions = document.getElementById('no-submissions');

        if (dashboardData.recent_submissions && dashboardData.recent_submissions.length > 0) {
            noSubmissions.style.display = 'none';
            submissionsList.innerHTML = '';

            dashboardData.recent_submissions.forEach(sub => {
                const subItem = document.createElement('div');
                subItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                subItem.innerHTML = `
                    <div>
                        <h4 class="font-medium text-gray-800">${sub.project_title}</h4>
                        <p class="text-sm text-gray-500">Student: ${sub.student_name || 'Unassigned'} • ${formatDate(sub.submitted_on)}</p>
                    </div>
                    <button class="px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-sm view-feedback hover:bg-purple-200 active:scale-95 transition-all duration-150 font-semibold" data-project-id="${sub.project_id}" data-tab="feedback" data-submission-id="${sub.id}" aria-label="Review submission for ${sub.project_title}">
                        Review
                    </button>
                `;
                submissionsList.appendChild(subItem);
            });

            document.querySelectorAll('#recent-submissions .view-feedback').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-project-id');
                    const tab = btn.getAttribute('data-tab');
                    const submissionId = btn.getAttribute('data-submission-id');
                    await openProjectModal(projectId, tab, submissionId);
                });
            });
        } else {
            submissionsList.innerHTML = '';
            noSubmissions.style.display = 'block';
        }

        const deadlineList = document.getElementById('faculty-deadline-list');
        const noDeadlines = document.getElementById('no-faculty-deadlines');

        if (dashboardData.urgent_deadlines && dashboardData.urgent_deadlines.length > 0) {
            noDeadlines.style.display = 'none';
            deadlineList.innerHTML = '';

            dashboardData.urgent_deadlines.forEach(project => {
                const daysLeft = Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                const deadlineItem = document.createElement('div');
                deadlineItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                deadlineItem.innerHTML = `
                    <div>
                        <h4 class="font-medium text-gray-800">${project.title}</h4>
                        <p class="text-sm text-gray-500">Student: ${project.student_name || 'Unassigned'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium ${daysLeft <= 3 ? 'text-red-600' : 'text-gray-600'}">
                            ${formatDate(project.deadline)}
                        </p>
                        <p class="text-xs ${daysLeft <= 3 ? 'text-red-500' : 'text-gray-500'}">
                            ${daysLeft > 0 ? `${daysLeft} days left` : 'Due today'}
                        </p>
                    </div>
                `;
                deadlineList.appendChild(deadlineItem);
            });
        } else {
            deadlineList.innerHTML = '';
            noDeadlines.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading faculty dashboard:', error);
        alert('Failed to load faculty dashboard data.');
        document.getElementById('faculty-total-projects').textContent = '0';
        document.getElementById('faculty-ongoing-projects').textContent = '0';
        document.getElementById('faculty-pending-projects').textContent = '0';
        document.getElementById('faculty-completed-projects').textContent = '0';
        if (facultyDashboardChartInstance) facultyDashboardChartInstance.destroy();
        document.getElementById('recent-submissions').innerHTML = '';
        document.getElementById('no-submissions').style.display = 'block';
        document.getElementById('faculty-deadline-list').innerHTML = '';
        document.getElementById('no-faculty-deadlines').style.display = 'block';
    }
}

// Faculty Projects
async function loadFacultyProjects() {
    const filter = document.getElementById('faculty-project-filter').value;
    const search = document.getElementById('project-search').value.toLowerCase();
    const projectList = document.getElementById('faculty-project-list');
    projectList.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading projects...</p>
            </td>
        </tr>
    `;

    try {
        const statusQuery = filter === 'all' ? '' : `&status=${filter}`;
        const searchQuery = search ? `&search=${search}` : '';
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?faculty_id=${currentUser.id}${statusQuery}${searchQuery}`);
        const projects = await response.json();

        if (projects.length > 0) {
            projectList.innerHTML = '';
            projects.forEach((project, index) => {
                const daysLeft = project.deadline ? Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : 'N/A';
                const deadlineText = daysLeft === 'N/A' ? 'N/A' : (daysLeft > 0 ? `${daysLeft} days left` : (daysLeft === 0 ? 'Due today' : 'Overdue'));
                const deadlineClass = daysLeft === 'N/A' ? '' : (daysLeft <= 3 && daysLeft >= 0 ? 'text-red-500 font-semibold' : (daysLeft < 0 ? 'text-red-700 font-semibold' : ''));

                const projectRow = document.createElement('tr');
                projectRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                projectRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${project.title}</div>
                                <div class="text-sm text-gray-500">${project.description.substring(0, 50)}${project.description.length > 50 ? '...' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${project.student_name || 'Unassigned'}</div>
                        <div class="text-xs text-gray-500">${project.student_name ? 'Student' : 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.visibility)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${project.creator_name || 'N/A'}</div>
                        <div class="text-xs text-gray-500">${project.creator_role || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(project.deadline)}</div>
                        <div class="text-xs text-gray-500 ${deadlineClass}">
                            ${deadlineText}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-purple-600 hover:text-purple-900 view-project active:scale-95 transition-all duration-150 mr-3" data-id="${project.id}" aria-label="View details for ${project.title}">View Details</button>
                        <button class="text-blue-600 hover:text-blue-900 edit-project active:scale-95 transition-all duration-150 mr-3" data-id="${project.id}" aria-label="Edit ${project.title}">Edit</button>
                        <button class="text-red-600 hover:text-red-900 delete-project active:scale-95 transition-all duration-150" data-id="${project.id}" aria-label="Delete ${project.title}">Delete</button>
                    </td>
                `;
                projectList.appendChild(projectRow);
            });

            document.querySelectorAll('#faculty-project-list .view-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await openProjectModal(projectId);
                });
            });

            document.querySelectorAll('#faculty-project-list .edit-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    alert(`Edit project ${projectId} - functionality to be implemented.`);
                });
            });

            document.querySelectorAll('#faculty-project-list .delete-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    if (confirm(`Are you sure you want to delete project "${btn.closest('tr').querySelector('.text-base').textContent}"? This action cannot be undone.`)) {
                        await deleteProject(projectId);
                    }
                });
            });

        } else {
            projectList.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No projects created</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading faculty projects:', error);
        projectList.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="7" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load projects.</p>
                </td>
            </tr>
        `;
    }
}

window.deleteProject = function(projectId) {
    if (!confirm('Are you sure you want to delete this project?')) {
        return;
    }
    
    // Remove from UI immediately
    const allTables = document.querySelectorAll('table');
    let rowToRestore = null;
    
    allTables.forEach(table => {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            if (row.innerHTML.includes(projectId)) {
                rowToRestore = row.cloneNode(true);
                row.remove();
            }
        });
    });
    
    // Call backend API to delete from database
    authenticatedFetch(`${API_BASE_URL}/admin/projects/${projectId}`, {
        method: 'DELETE',
        headers: { 
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            showNotification('Project deleted successfully!', 'success');
        } else {
            // Restore row if backend deletion failed
            if (rowToRestore) {
                const projectsList = document.getElementById('admin-projects-list');
                if (projectsList) {
                    projectsList.appendChild(rowToRestore);
                }
            }
            showNotification('Failed to delete project from database', 'error');
        }
    })
    .catch(error => {
        // Restore row if API call failed
        if (rowToRestore) {
            const projectsList = document.getElementById('admin-projects-list');
            if (projectsList) {
                projectsList.appendChild(rowToRestore);
            }
        }
        showNotification('Error deleting project: ' + error.message, 'error');
    });
}

// Faculty Submissions
async function loadFacultySubmissions() {
    const submissionList = document.getElementById('submission-list');
    const submissionReviewFilter = document.getElementById('submission-review-filter');
    const submissionReviewSearch = document.getElementById('submission-review-search');

    submissionList.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading submissions to review...</p>
            </td>
        </tr>
    `;

    try {
        const statusQuery = submissionReviewFilter.value === 'all' ? '' : `&status=${submissionReviewFilter.value}`;
        const searchQuery = submissionReviewSearch.value ? `&search=${submissionReviewSearch.value.toLowerCase()}` : '';
        const response = await authenticatedFetch(`${API_BASE_URL}/submissions?faculty_id=${currentUser.id}${statusQuery}${searchQuery}`);
        const submissions = await response.json();

        if (submissions.length > 0) {
            submissionList.innerHTML = '';
            submissions.forEach((sub, index) => {
                const submissionRow = document.createElement('tr');
                submissionRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                submissionRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${sub.project_title}</div>
                                <div class="text-sm text-gray-500">${sub.note ? sub.note.substring(0, 50) + (sub.note.length > 50 ? '...' : '') : 'No notes'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${sub.student_name || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(sub.submitted_on)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(sub.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-purple-600 hover:text-purple-900 view-feedback active:scale-95 transition-all duration-150" data-project-id="${sub.project_id}" data-tab="feedback" data-submission-id="${sub.id}" aria-label="Review submission for ${sub.project_title}">Review Submission</button>
                    </td>
                `;
                submissionList.appendChild(submissionRow);
            });

            document.querySelectorAll('#submission-list .view-feedback').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-project-id');
                    const tab = btn.getAttribute('data-tab');
                    const submissionId = btn.getAttribute('data-submission-id');
                    await openProjectModal(projectId, tab, submissionId);
                });
            });
        } else {
            submissionList.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-check-circle text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No submissions to review</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading faculty submissions:', error);
        submissionList.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="5" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load submissions.</p>
                </td>
            </tr>
        `;
    }
}

// Faculty Students
async function loadFacultyStudents() {
    const studentDirectory = document.getElementById('student-directory');
    const studentDirectorySearch = document.getElementById('student-directory-search');
    const studentDirectoryFilter = document.getElementById('student-directory-filter');

    studentDirectory.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading students...</p>
            </td>
        </tr>
    `;

    try {
        const searchQuery = studentDirectorySearch.value ? `&search=${studentDirectorySearch.value.toLowerCase()}` : '';
        const response = await authenticatedFetch(`${API_BASE_URL}/users?role=student&faculty_id=${currentUser.id}${searchQuery}`);
        let studentsWithStats = await response.json();

        if (studentDirectoryFilter.value === 'active') {
            studentsWithStats = studentsWithStats.filter(s => s.project_count > 0 && s.on_time_percentage !== 'N/A');
        } else if (studentDirectoryFilter.value === 'completed') {
            studentsWithStats = studentsWithStats.filter(s => s.project_count > 0 && s.on_time_percentage === '100');
        }

        if (studentsWithStats.length > 0) {
            studentDirectory.innerHTML = '';
            studentsWithStats.forEach((student, index) => {
                const studentRow = document.createElement('tr');
                studentRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                studentRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${student.name}</div>
                                <div class="text-sm text-gray-500">${student.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${student.project_count}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${student.avg_grade ?? 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${student.on_time_percentage !== 'N/A' ? student.on_time_percentage : 0}%"></div>
                            </div>
                            <span class="ml-2 text-sm text-gray-500">${student.on_time_percentage ?? 'N/A'}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-purple-600 hover:text-purple-900 view-student active:scale-95 transition-all duration-150" data-id="${student.id}" aria-label="View profile for ${student.name}">View Profile</button>
                    </td>
                `;
                studentDirectory.appendChild(studentRow);
            });

            document.querySelectorAll('#student-directory .view-student').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const studentId = btn.getAttribute('data-id');
                    await viewStudentProfile(studentId);
                });
            });
        } else {
            studentDirectory.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="5" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-user-graduate text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No students assigned</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading faculty students:', error);
        studentDirectory.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="5" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load students.</p>
                </td>
            </tr>
        `;
    }
}

// Faculty Create Project
async function loadFacultyCreateProject() {
    const studentSelect = document.getElementById('project-students');
    const privateAssignmentDiv = document.getElementById('private-assignment');
    const publicSettingsDiv = document.getElementById('public-settings');
    const projectVisibilitySelect = document.getElementById('project-visibility');

    studentSelect.innerHTML = '<option value="">Loading students...</option>';
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users?role=student`);
        const students = await response.json();

        studentSelect.innerHTML = '';
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = student.name;
            studentSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading students for project assignment:', error);
        studentSelect.innerHTML = '<option value="">Failed to load students</option>';
        alert('Failed to load students for project assignment.');
    }

    if (projectVisibilitySelect.value === 'private') {
        privateAssignmentDiv.style.display = 'block';
        publicSettingsDiv.style.display = 'none';
        studentSelect.setAttribute('required', 'required');
    } else {
        privateAssignmentDiv.style.display = 'none';
        publicSettingsDiv.style.display = 'block';
        studentSelect.removeAttribute('required');
    }

    projectVisibilitySelect.addEventListener('change', (e) => {
        const visibility = e.target.value;
        if (visibility === 'private') {
            privateAssignmentDiv.style.display = 'block';
            publicSettingsDiv.style.display = 'none';
            studentSelect.setAttribute('required', 'required');
        } else {
            privateAssignmentDiv.style.display = 'none';
            publicSettingsDiv.style.display = 'block';
            studentSelect.removeAttribute('required');
        }
    });

    const newProjectForm = document.getElementById('new-project-form');
    newProjectForm.onsubmit = async (e) => {
        e.preventDefault();

        const title = document.getElementById('project-title').value;
        const description = document.getElementById('project-description').value;
        const deadline = document.getElementById('project-deadline').value;
        const visibility = document.getElementById('project-visibility').value;
        let assignedTo = [];
        let teamSize = null;

        if (visibility === 'private') {
            const selectedStudentOptions = Array.from(document.getElementById('project-students').selectedOptions);
            if (selectedStudentOptions.length === 0) {
                alert('Please select at least one student to assign the private project to.');
                return;
            }
            assignedTo = selectedStudentOptions.map(option => option.value);
        } else {
            teamSize = parseInt(document.getElementById('team-size').value);
        }

        if (!title.trim() || !description.trim() || !deadline) {
            alert('Please fill in all required fields.');
            return;
        }

        if (title.length < 3) {
            alert('Project title must be at least 3 characters long.');
            return;
        }

        if (description.length < 10) {
            alert('Project description must be at least 10 characters long.');
            return;
        }

        const projectFiles = document.getElementById('project-files').files;
        const resources = [];
        if (projectFiles.length > 0) {
            alert("File uploads for project resources are not fully implemented in this version. Only project details will be saved.");
        }

        try {
            const response = await authenticatedFetch(`${API_BASE_URL}/projects`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    description,
                    assigned_to: visibility === 'private' ? assignedTo : null,
                    faculty_id: currentUser.id,
                    status: 'open',
                    visibility: visibility,
                    deadline,
                    team_size: teamSize,
                    resources: resources
                })
            });

            if (response.ok) {
                alert('Project created successfully!');
                document.getElementById('new-project-form').reset();
                document.getElementById('file-list').innerHTML = 'No files selected';

                projectVisibilitySelect.value = 'public';
                privateAssignmentDiv.style.display = 'none';
                publicSettingsDiv.style.display = 'block';
                studentSelect.removeAttribute('required');

                await loadFacultyProjects();
                document.querySelector('.sidebar-link[data-section="faculty-projects"]').click();
            } else {
                const errorData = await response.json();
                alert(`Failed to create project: ${errorData.detail || 'An error occurred.'}`);
            }
        } catch (error) {
            console.error('Error creating project:', error);
            alert('An error occurred while creating the project. Please try again.');
        }
    };

    document.getElementById('project-files').addEventListener('change', (e) => {
        const files = e.target.files;
        const fileList = document.getElementById('file-list');

        fileList.innerHTML = '';
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between py-1';
                fileItem.innerHTML = `
                    <span class="text-sm truncate">${file.name}</span>
                    <span class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)}KB</span>
                `;
                fileList.appendChild(fileItem);
            }
        } else {
            fileList.innerHTML = 'No files selected';
        }
    });

    document.getElementById('cancel-project').addEventListener('click', () => {
        document.getElementById('new-project-form').reset();
        document.getElementById('file-list').innerHTML = 'No files selected';
        projectVisibilitySelect.value = 'public';
        privateAssignmentDiv.style.display = 'none';
        publicSettingsDiv.style.display = 'block';
        studentSelect.removeAttribute('required');
        document.querySelector('.sidebar-link[data-section="faculty-dashboard"]').click();
    });
}

// Project Modal
async function openProjectModal(projectId, defaultTab = 'submissions', submissionId = null) {
    const projectModal = document.getElementById('project-modal');
    const projectModalContent = projectModal.querySelector('.modal-content-animated');
    projectModal.style.display = 'flex';
    setTimeout(() => {
        projectModalContent.classList.add('show');
    }, 10);

    currentSubmissionIdForFeedback = submissionId;

    document.getElementById('modal-project-title').textContent = 'Loading...';
    document.getElementById('modal-project-description').textContent = 'Loading...';
    document.getElementById('modal-project-status').innerHTML = getStatusBadge('loading');
    document.getElementById('modal-project-visibility').innerHTML = getStatusBadge('loading');
    document.getElementById('modal-project-deadline').textContent = 'Due: Loading...';
    document.getElementById('modal-project-student').textContent = 'Loading...';
    document.getElementById('modal-project-faculty').textContent = 'Loading...';
    document.getElementById('modal-project-resources').innerHTML = '<p class="text-gray-500 italic text-sm">Loading resources...</p>';
    document.getElementById('submission-history').innerHTML = '<p class="text-gray-500 italic text-center py-4">Loading submissions...</p>';
    document.getElementById('discussion-thread').innerHTML = '<p class="text-gray-500 italic text-center py-4">Loading discussion...</p>';
    document.getElementById('feedback-content').innerHTML = '<p class="text-gray-500 italic text-center py-4">Loading feedback...</p>';
    document.getElementById('comment-text').value = '';
    document.getElementById('new-feedback-form').reset();

    try {
        const projectResponse = await authenticatedFetch(`${API_BASE_URL}/projects/${projectId}`);
        const project = await projectResponse.json();

        const submissionsResponse = await authenticatedFetch(`${API_BASE_URL}/submissions?project_id=${projectId}`);
        const projectSubmissions = await submissionsResponse.json();

        const commentsResponse = await authenticatedFetch(`${API_BASE_URL}/comments/${projectId}`);
        const projectComments = await commentsResponse.json();

        document.getElementById('modal-project-title').textContent = project.title;
        document.getElementById('modal-project-description').textContent = project.description;
        document.getElementById('modal-project-status').innerHTML = getStatusBadge(project.status);
        document.getElementById('modal-project-visibility').innerHTML = getStatusBadge(project.visibility);
        document.getElementById('modal-project-deadline').textContent = `Due: ${formatDate(project.deadline)}`;
        document.getElementById('modal-project-student').textContent = project.student_name || 'Unassigned (Public Project)';
        document.getElementById('modal-project-faculty').textContent = project.faculty_name || 'N/A';

        const modalProjectResources = document.getElementById('modal-project-resources');
        if (project.resources && project.resources.length > 0) {
            modalProjectResources.innerHTML = project.resources.map(resource => `
                <a href="${resource.url}" target="_blank" class="text-purple-600 hover:underline flex items-center">
                    <i class="fas fa-link mr-2"></i> ${resource.name || resource.url}
                </a>
            `).join('');
        } else {
            modalProjectResources.innerHTML = '<p class="text-gray-500 italic text-sm">No resources provided</p>';
        }

        const isFaculty = currentUser.role === 'faculty';
        document.getElementById('student-submission-form').style.display = isFaculty ? 'none' : 'block';
        document.getElementById('faculty-feedback-form').style.display = isFaculty ? 'block' : 'none';

        const submissionHistory = document.getElementById('submission-history');
        const feedbackContent = document.getElementById('feedback-tab').querySelector('#feedback-content');

        if (projectSubmissions.length > 0) {
            submissionHistory.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Submission History</h4>
                ${projectSubmissions.map(sub => `
                    <div class="border border-gray-200 rounded-lg p-4 mb-3 bg-white shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-sm font-medium text-gray-700">${formatDate(sub.submitted_on)}</span>
                                ${sub.grade !== null ?
                                    `<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full font-semibold">
                                        Grade: ${sub.grade}/100
                                    </span>` : ''}
                            </div>
                            ${getStatusBadge(sub.status)}
                        </div>
                        <div class="mb-2">
                            <p class="text-sm text-gray-700">${sub.note || 'No notes provided'}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${sub.file_paths.map(file => `
                                <a href="${file.url}" target="_blank" class="px-2.5 py-1.5 bg-gray-100 text-gray-800 text-xs rounded-md flex items-center hover:bg-gray-200 transition-colors duration-150">
                                    <i class="fas fa-file mr-1"></i> ${file.name}
                                </a>
                            `).join('')}
                        </div>
                        ${sub.feedback ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h5 class="text-sm font-semibold text-gray-800 mb-1">Faculty Feedback</h5>
                                <p class="text-sm text-gray-700">${sub.feedback}</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            const latestSubmissionWithFeedback = projectSubmissions.filter(s => s.feedback).sort((a, b) => new Date(b.submitted_on) - new Date(a.submitted_on))[0];
            if (latestSubmissionWithFeedback) {
                feedbackContent.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Latest Feedback</h4>
                    <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-sm font-medium text-gray-700">On: ${formatDate(latestSubmissionWithFeedback.submitted_on)}</span>
                                ${latestSubmissionWithFeedback.grade !== null ?
                                    `<span class="ml-2 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full font-semibold">
                                        Grade: ${latestSubmissionWithFeedback.grade}/100
                                    </span>` : ''}
                            </div>
                            ${getStatusBadge(latestSubmissionWithFeedback.status)}
                        </div>
                        <p class="text-base text-gray-800">${latestSubmissionWithFeedback.feedback}</p>
                        ${latestSubmissionWithFeedback.note ? `<p class="text-sm text-gray-600 mt-2">Student Notes: ${latestSubmissionWithFeedback.note}</p>` : ''}
                    </div>
                `;
            } else {
                feedbackContent.innerHTML = '<p class="text-gray-500 italic text-center py-4">No feedback yet</p>';
            }

        } else {
            submissionHistory.innerHTML = '<p class="text-gray-500 italic text-center py-4">No submissions yet</p>';
            feedbackContent.innerHTML = '<p class="text-gray-500 italic text-center py-4">No feedback yet</p>';
        }

        const discussionThread = document.getElementById('discussion-thread');

        if (projectComments.length > 0) {
            discussionThread.innerHTML = projectComments.map(comment => {
                return `
                    <div class="flex space-x-3 items-start">
                        <div class="flex-shrink-0 h-9 w-9 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg font-semibold">
                            ${comment.user_name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-lg p-3">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-sm font-semibold text-gray-800">${comment.user_name}</span>
                                    <span class="text-xs text-gray-500">${formatDateTime(comment.timestamp)}</span>
                                </div>
                                <p class="text-sm text-gray-800">${comment.comment_text}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            discussionThread.scrollTop = discussionThread.scrollHeight;
        } else {
            discussionThread.innerHTML = '<p class="text-gray-500 italic text-center py-4">No discussion yet. Start a conversation!</p>';
        }

        document.querySelectorAll('.submission-tab').forEach(tab => {
            tab.classList.remove('border-purple-600', 'text-purple-600');
            tab.classList.add('text-gray-500');
            tab.setAttribute('aria-selected', 'false');
        });

        const activeTab = document.querySelector(`.submission-tab[data-tab="${defaultTab}"]`);
        const activeContent = document.getElementById(`${defaultTab}-tab`);

        if (activeTab && activeContent) {
            activeTab.classList.add('border-purple-600', 'text-purple-600');
            activeTab.setAttribute('aria-current', 'true');
            activeContent.style.display = 'block';
        } else {
            document.querySelector('.submission-tab[data-tab="submissions"]').classList.add('border-purple-600', 'text-purple-600');
            document.querySelector('.submission-tab[data-tab="submissions"]').setAttribute('aria-current', 'true');
            document.getElementById('submissions-tab').style.display = 'block';
        }

        document.querySelectorAll('.submission-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                document.querySelectorAll('.submission-tab').forEach(t => {
                    t.classList.remove('border-purple-600', 'text-purple-600');
                    t.classList.add('text-gray-500');
                    t.setAttribute('aria-selected', 'false');
                });

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                tab.classList.add('border-purple-600', 'text-purple-600');
                tab.setAttribute('aria-selected', 'true');
                document.getElementById(`${tabName}-tab`).style.display = 'block';
            });
        });

        const newCommentForm = document.getElementById('new-comment-form');
        newCommentForm.onsubmit = async (e) => {
            e.preventDefault();

            const commentText = document.getElementById('comment-text').value;
            if (!commentText.trim()) return;

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ project_id: projectId, comment_text })
                });

                if (response.ok) {
                    document.getElementById('comment-text').value = '';
                    await openProjectModal(projectId, 'discussion');
                } else {
                    const errorData = await response.json();
                    alert(`Failed to add comment: ${errorData.detail || 'An error occurred.'}`);
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('An error occurred while adding your comment. Please try again.');
            }
        };

        const newSubmissionForm = document.getElementById('new-submission-form');
        newSubmissionForm.onsubmit = async (e) => {
            e.preventDefault();

            const files = document.getElementById('submission-files').files;
            const notes = document.getElementById('submission-notes').value;

            if (files.length === 0) {
                alert('Please select at least one file to submit');
                return;
            }

            const formData = new FormData();
            formData.append('project_id', projectId);
            formData.append('note', notes);
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/submissions`, {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    alert('Work submitted successfully!');
                    document.getElementById('new-submission-form').reset();
                    document.getElementById('submission-file-list').innerHTML = '<p>No files selected</p>';
                    document.getElementById('submission-file-preview').innerHTML = '';

                    await openProjectModal(projectId, 'submissions');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit work');
                }
            } catch (error) {
                console.error('Error submitting work:', error);
                alert('An error occurred while submitting your work. Please try again.');
            }
        };

        const submissionFilesInput = document.getElementById('submission-files');
        submissionFilesInput.onchange = (e) => {
            const files = e.target.files;
            const fileList = document.getElementById('submission-file-list');
            const filePreview = document.getElementById('submission-file-preview');

            fileList.innerHTML = '';
            filePreview.innerHTML = '';

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between py-1';
                    fileItem.innerHTML = `
                        <span class="text-sm truncate">${file.name}</span>
                        <span class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)}KB</span>
                    `;
                    fileList.appendChild(fileItem);

                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative group';
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewItem.innerHTML = `<img src="${e.target.result}" alt="${file.name}" class="w-full h-24 object-cover rounded-md border border-gray-200">`;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        let iconClass = 'fas fa-file';
                        if (file.type.includes('pdf')) iconClass = 'fas fa-file-pdf';
                        else if (file.type.includes('word') || file.type.includes('document')) iconClass = 'fas fa-file-word';
                        else if (file.type.includes('excel') || file.type.includes('spreadsheet')) iconClass = 'fas fa-file-excel';
                        else if (file.type.includes('zip') || file.type.includes('rar')) iconClass = 'fas fa-file-archive';

                        previewItem.innerHTML = `
                            <div class="w-full h-24 flex items-center justify-center bg-gray-100 rounded-md border border-gray-200 text-gray-500 text-4xl">
                                <i class="${iconClass}"></i>
                            </div>
                        `;
                    }
                    previewItem.innerHTML += `
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-md">
                            <span class="text-white text-xs text-center p-1">${file.name}</span>
                        </div>
                    `;
                    filePreview.appendChild(previewItem);
                }
            } else {
                fileList.innerHTML = '<p>No files selected</p>';
            }
        };

        const newFeedbackForm = document.getElementById('new-feedback-form');
        newFeedbackForm.onsubmit = async (e) => {
            e.preventDefault();

            const feedbackText = document.getElementById('feedback-text').value;
            const grade = document.getElementById('feedback-grade').value;
            const projectNewStatus = document.getElementById('feedback-status').value;

            if (!feedbackText.trim()) {
                alert('Please provide feedback comments');
                return;
            }

            if (!currentSubmissionIdForFeedback) {
                alert('No specific submission selected for feedback. Please select a submission from the list.');
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/submissions/${currentSubmissionIdForFeedback}/feedback`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        feedback: feedbackText,
                        grade: grade ? parseInt(grade) : null,
                        project_status_update: projectNewStatus
                    })
                });

                if (response.ok) {
                    alert('Feedback submitted successfully!');
                    document.getElementById('new-feedback-form').reset();
                    await openProjectModal(projectId, 'feedback');
                } else {
                    const errorData = await response.json();
                    alert(`Failed to submit feedback: ${errorData.detail || 'An error occurred.'}`);
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('An error occurred while submitting your feedback. Please try again.');
            }
        };
    } catch (error) {
        console.error('Error opening project modal:', error);
        alert('Failed to load project details. Please try again.');
        projectModalContent.classList.remove('show');
        setTimeout(() => { projectModal.style.display = 'none'; }, 300);
    }

    document.getElementById('close-project-modal').onclick = async () => {
        projectModalContent.classList.remove('show');
        setTimeout(async () => {
            projectModal.style.display = 'none';
            currentSubmissionIdForFeedback = null;
            if (currentUser.role === 'student') {
                const currentStudentSection = document.querySelector('#student-menu .sidebar-link.active')?.getAttribute('data-section');
                if (currentStudentSection) await loadSectionData(currentStudentSection);
            } else {
                const currentFacultySection = document.querySelector('#faculty-menu .sidebar-link.active')?.getAttribute('data-section');
                if (currentFacultySection) await loadSectionData(currentFacultySection);
            }
        }, 300);
    };
}

// View Student Profile
let studentProfileChartInstance = null;
const studentProfileModal = document.getElementById('student-profile-modal');
const closeStudentProfileModalBtn = document.getElementById('close-student-profile-modal');

closeStudentProfileModalBtn.addEventListener('click', () => {
    if (studentProfileChartInstance) {
        studentProfileChartInstance.destroy();
        studentProfileChartInstance = null;
    }
    studentProfileModal.querySelector('.modal-content-animated').classList.remove('show');
    setTimeout(() => {
        studentProfileModal.style.display = 'none';
    }, 300);
});

async function viewStudentProfile(studentId) {
    studentProfileModal.style.display = 'flex';
    setTimeout(() => {
        studentProfileModal.querySelector('.modal-content-animated').classList.add('show');
    }, 10);

    document.getElementById('student-profile-title').textContent = 'Student Profile: Loading...';
    document.getElementById('student-profile-username').textContent = 'Loading...';
    document.getElementById('student-profile-projects-count').textContent = 'Loading...';
    document.getElementById('student-profile-avg-grade').textContent = 'Loading...';
    document.getElementById('student-profile-recent-projects').innerHTML = '<p class="text-gray-500 italic text-center py-4">Loading projects...</p>';
    if (studentProfileChartInstance) {
        studentProfileChartInstance.destroy();
        studentProfileChartInstance = null;
    }

    try {
        const res = await authenticatedFetch(`${API_BASE_URL}/students/${studentId}`);
        const data = await res.json();

        document.getElementById('student-profile-title').textContent = `Student Profile: ${data.username}`;
        document.getElementById('student-profile-username').textContent = data.username;
        document.getElementById('student-profile-projects-count').textContent = data.projects_count;
        document.getElementById('student-profile-avg-grade').textContent = data.avg_grade ?? 'N/A';

        const ctx = document.getElementById('student-performance-chart').getContext('2d');
        if (studentProfileChartInstance) studentProfileChartInstance.destroy();
        studentProfileChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.performance.map(p => p.label),
                datasets: [{
                    label: 'Grade',
                    data: data.performance.map(p => p.value),
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Grade' } },
                    x: { title: { display: true, text: 'Submission Date' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        const projectsContainer = document.getElementById('student-profile-recent-projects');
        projectsContainer.innerHTML = '';
        if (data.recent_projects.length > 0) {
            data.recent_projects.forEach(p => {
                const projectEl = document.createElement('div');
                projectEl.className = 'p-4 border rounded-lg bg-gray-50';
                projectEl.innerHTML = `<h4 class="font-semibold text-gray-800">${p.title}</h4><p class="text-sm text-gray-600">${p.description.substring(0, 100)}${p.description.length > 100 ? '...' : ''}</p>`;
                projectsContainer.appendChild(projectEl);
            });
        } else {
            projectsContainer.innerHTML = `<p class="text-gray-500 italic text-center py-4">No recent projects</p>`;
        }

    } catch (err) {
        console.error(err);
        alert('Error loading student profile.');
        if (studentProfileChartInstance) {
            studentProfileChartInstance.destroy();
            studentProfileChartInstance = null;
        }
        studentProfileModal.querySelector('.modal-content-animated').classList.remove('show');
        setTimeout(() => { studentProfileModal.style.display = 'none'; }, 300);
    }
}
// Faculty Analytics
let facultyStatusChartInstance = null;
let facultyTimelineChartInstance = null;
let facultyPerformanceChartInstance = null;

async function loadFacultyAnalytics() {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/analytics/faculty`);
        const analyticsData = await response.json();

        // Status Distribution Chart
        const statusLabels = Object.keys(analyticsData.status_counts).map(s => s.replace('_', ' ').replace(/\b\w/g, char => char.toUpperCase()));
        const statusData = Object.values(analyticsData.status_counts);

        const facultyStatusCtx = document.getElementById('faculty-status-chart').getContext('2d');
        if (facultyStatusChartInstance) {
            facultyStatusChartInstance.destroy();
        }
        facultyStatusChartInstance = new Chart(facultyStatusCtx, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: ['#3B82F6', '#FBBF24', '#10B981', '#A78BFA', '#EF4444', '#6B7280'],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed}` } }
                }
            }
        });

        // Timeline Completion Chart
        const completionLabels = analyticsData.completion_history.map(item => item.date);
        const completionData = analyticsData.completion_history.map(item => item.count);

        const facultyTimelineCtx = document.getElementById('faculty-timeline-chart').getContext('2d');
        if (facultyTimelineChartInstance) {
            facultyTimelineChartInstance.destroy();
        }
        facultyTimelineChartInstance = new Chart(facultyTimelineCtx, {
            type: 'line',
            data: {
                labels: completionLabels,
                datasets: [{
                    label: 'Projects Completed',
                    data: completionData,
                    borderColor: '#7c3aed',
                    backgroundColor: 'rgba(124, 58, 237, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Number of Projects' } },
                    x: { title: { display: true, text: 'Month' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Student Performance Chart
        const performanceLabels = analyticsData.student_performance.map(s => s.name);
        const performanceData = analyticsData.student_performance.map(s => s.avg_grade);

        const facultyPerformanceCtx = document.getElementById('faculty-performance-chart').getContext('2d');
        if (facultyPerformanceChartInstance) {
            facultyPerformanceChartInstance.destroy();
        }
        facultyPerformanceChartInstance = new Chart(facultyPerformanceCtx, {
            type: 'bar',
            data: {
                labels: performanceLabels,
                datasets: [{
                    label: 'Average Grade',
                    data: performanceData,
                    backgroundColor: '#34D399',
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Average Grade (out of 100)' } },
                    x: { title: { display: true, text: 'Student' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    } catch (error) {
        console.error('Error loading faculty analytics:', error);
        alert('Failed to load faculty analytics data.');
        if (facultyStatusChartInstance) facultyStatusChartInstance.destroy();
        if (facultyTimelineChartInstance) facultyTimelineChartInstance.destroy();
        if (facultyPerformanceChartInstance) facultyPerformanceChartInstance.destroy();
    }
}

// Faculty Approve Projects
async function loadFacultyApproveProjects() {
    const approvalProjectList = document.getElementById('approval-project-list');
    const approvalProjectSearch = document.getElementById('approval-project-search');
    const approvalProjectFilter = document.getElementById('approval-project-filter');

    approvalProjectList.innerHTML = `
        <tr class="even:bg-gray-50">
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 text-gray-400"></i>
                <p class="text-lg">Loading projects pending approval...</p>
            </td>
        </tr>
    `;

    try {
        const statusQuery = approvalProjectFilter.value === 'all' ? '' : `&status=${approvalProjectFilter.value}`;
        const searchQuery = approvalProjectSearch.value ? `&search=${approvalProjectSearch.value.toLowerCase()}` : '';
        const response = await authenticatedFetch(`${API_BASE_URL}/projects?faculty_id=${currentUser.id}${statusQuery}${searchQuery}`);
        const projectsToApprove = await response.json();

        if (projectsToApprove.length > 0) {
            approvalProjectList.innerHTML = '';
            projectsToApprove.forEach((project, index) => {
                const daysLeft = project.deadline ? Math.ceil((new Date(project.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : 'N/A';
                const deadlineText = daysLeft === 'N/A' ? 'N/A' : (daysLeft > 0 ? `${daysLeft} days left` : (daysLeft === 0 ? 'Due today' : 'Overdue'));
                const deadlineClass = daysLeft === 'N/A' ? '' : (daysLeft <= 3 && daysLeft >= 0 ? 'text-red-500 font-semibold' : (daysLeft < 0 ? 'text-red-700 font-semibold' : ''));

                const projectRow = document.createElement('tr');
                projectRow.className = `hover:bg-gray-50 ${index % 2 === 1 ? 'bg-gray-50' : ''}`;
                projectRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-base font-medium text-gray-900">${project.title}</div>
                                <div class="text-sm text-gray-500">${project.description.substring(0, 50)}${project.description.length > 50 ? '...' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${project.student_name || 'N/A'}</div>
                        <div class="text-xs text-gray-500">${project.student_name ? 'Student' : 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.visibility)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(project.deadline)}</div>
                        <div class="text-xs text-gray-500 ${deadlineClass}">
                            ${deadlineText}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-green-600 hover:text-green-900 approve-project active:scale-95 transition-all duration-150 mr-3" data-id="${project.id}" aria-label="Approve ${project.title}">Approve</button>
                        <button class="text-red-600 hover:text-red-900 reject-project active:scale-95 transition-all duration-150" data-id="${project.id}" aria-label="Reject ${project.title}">Reject</button>
                    </td>
                `;
                approvalProjectList.appendChild(projectRow);
            });

            document.querySelectorAll('.approve-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await updateProjectApprovalStatus(projectId, 'ongoing');
                });
            });

            document.querySelectorAll('.reject-project').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const projectId = btn.getAttribute('data-id');
                    await updateProjectApprovalStatus(projectId, 'rejected');
                });
            });

        } else {
            approvalProjectList.innerHTML = `
                <tr class="even:bg-gray-50">
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i>
                        <p class="text-lg">No projects pending approval</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading projects pending approval:', error);
        approvalProjectList.innerHTML = `
            <tr class="even:bg-gray-50">
                <td colspan="6" class="px-6 py-10 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p class="text-lg">Failed to load projects pending approval.</p>
                </td>
            </tr>
        `;
    }
}

async function updateProjectApprovalStatus(projectId, status) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/projects/${projectId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: status })
        });

        if (response.ok) {
            alert(`Project ${status === 'ongoing' ? 'approved' : 'rejected'} successfully!`);
            await loadFacultyApproveProjects(); // Refresh the list
        } else {
            const errorData = await response.json();
            alert(`Failed to update project status: ${errorData.detail || 'An error occurred.'}`);
        }
    } catch (error) {
        console.error('Error updating project approval status:', error);
        alert('An error occurred while updating project status. Please try again.');
    }
}

// Faculty Reports
function loadFacultyReports() {
    document.querySelectorAll('#faculty-reports button').forEach(button => {
        button.addEventListener('click', () => {
            alert(`Exporting "${button.textContent.trim()}" is a placeholder. In a real app, this would trigger a server-side report generation.`);
        });
    });
}

// Theme toggle functionality
function toggleTheme() {
    const body = document.body;
    const icon = themeToggleBtn.querySelector('i');

    if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        icon.classList.replace('fa-sun', 'fa-moon');
        localStorage.setItem('theme', 'light');
    } else {
        body.classList.add('dark');
        icon.classList.replace('fa-moon', 'fa-sun');
        localStorage.setItem('theme', 'dark');
    }
}

themeToggleBtn.addEventListener('click', toggleTheme);

function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme');
    const body = document.body;
    const icon = themeToggleBtn.querySelector('i');

    if (savedTheme === 'dark') {
        body.classList.add('dark');
        icon.classList.replace('fa-moon', 'fa-sun');
    } else {
        body.classList.remove('dark');
        icon.classList.replace('fa-sun', 'fa-moon');
    }
}

// Admin Dashboard Functions
let adminActivityChartInstance = null;
let adminUserChartInstance = null;

async function loadAdminDashboard() {
    console.log('Loading admin dashboard...');
    console.log('Current user:', currentUser);
    console.log('User token:', userToken);
    
    // Check if user is authenticated
    if (!currentUser || !userToken) {
        console.error('No authenticated user found');
        return;
    }
    
    // Set loading state
    document.getElementById('admin-total-users').textContent = '...';
    document.getElementById('admin-active-projects').textContent = '...';
    document.getElementById('admin-pending-approvals').textContent = '...';
    document.getElementById('admin-total-submissions').textContent = '...';
    
    try {
        console.log('Making API requests to admin endpoints...');
        
        // Load admin dashboard stats from dedicated endpoint
        const statsResponse = await authenticatedFetch(`${API_BASE_URL}/admin/stats`);
        console.log('Admin stats response status:', statsResponse.status);
        
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            console.log('Admin stats data:', stats);
            
            // Update dashboard stats with real data
            document.getElementById('admin-total-users').textContent = stats.total_users;
            document.getElementById('admin-active-projects').textContent = stats.active_projects;
            document.getElementById('admin-pending-approvals').textContent = stats.pending_approvals;
            document.getElementById('admin-total-submissions').textContent = stats.total_submissions;
            
            // Load analytics data for charts
            const analyticsResponse = await authenticatedFetch(`${API_BASE_URL}/admin/analytics`);
            if (analyticsResponse.ok) {
                const analytics = await analyticsResponse.json();
                console.log('Admin analytics data:', analytics);
                
                // Update charts with real data
                setTimeout(() => {
                    createAdminCharts(analytics.user_distribution, analytics.project_distribution, analytics.activity_timeline);
                }, 200);
            }
            
            console.log('Admin dashboard updated with real data');
        } else {
            console.error('Admin stats API request failed:', statsResponse.status);
            // Set error state
            document.getElementById('admin-total-users').textContent = 'Error';
            document.getElementById('admin-active-projects').textContent = 'Error';
            document.getElementById('admin-pending-approvals').textContent = 'Error';
            document.getElementById('admin-total-submissions').textContent = 'Error';
        }
    } catch (error) {
        console.error('Error loading admin dashboard:', error);
        console.log('Using default values for admin dashboard');
    }
}

function createAdminCharts(users, projects, submissions) {
    try {
        // Activity Chart
        const activityCanvas = document.getElementById('admin-activity-chart');
        if (activityCanvas) {
            const activityCtx = activityCanvas.getContext('2d');
            if (adminActivityChartInstance) {
                adminActivityChartInstance.destroy();
            }
            
            adminActivityChartInstance = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Projects Created',
                        data: [12, 19, 8, 15, 22, 13],
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Projects Completed',
                        data: [8, 12, 6, 10, 18, 11],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
            console.log('Admin activity chart created successfully');
        }
        
        // User Distribution Chart
        const userCanvas = document.getElementById('admin-user-chart');
        if (userCanvas) {
            const userCtx = userCanvas.getContext('2d');
            if (adminUserChartInstance) {
                adminUserChartInstance.destroy();
            }
            
            const studentCount = users.filter(u => u.role === 'student').length;
            const facultyCount = users.filter(u => u.role === 'faculty').length;
            const adminCount = users.filter(u => u.role === 'admin').length;
            
            adminUserChartInstance = new Chart(userCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Faculty', 'Admins'],
                    datasets: [{
                        data: [studentCount, facultyCount, adminCount],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            console.log('Admin user distribution chart created successfully');
        }
    } catch (error) {
        console.error('Error creating admin charts:', error);
    }
}

// Admin section loading functions
function loadAdminSettings() {
    console.log('Admin settings loaded');
}


async function loadAdminAnalytics() {
    console.log('Admin analytics loaded');
}

function loadAdminReports() {
    console.log('Admin reports loaded');
}

async function loadAdminLogs() {
    console.log('Loading admin activity logs...');
    const logsList = document.getElementById('admin-logs-list');
    if (!logsList) {
        console.error('Admin logs list element not found');
        return;
    }

    // Show loading state
    logsList.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <i class="fas fa-spinner fa-spin mr-2 text-gray-400"></i>
            <span class="text-gray-500">Loading activity logs...</span>
        </div>
    `;

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/admin/logs`);
        console.log('Admin logs response status:', response.status);
        
        if (response.ok) {
            const logs = await response.json();
            console.log('Admin logs data:', logs.length, 'activities');
            
            if (logs.length === 0) {
                logsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clipboard-list text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-500">No activity logs found.</p>
                        <p class="text-gray-400 text-sm">Activity will appear here as users interact with the system.</p>
                    </div>
                `;
            } else {
                logsList.innerHTML = logs.map(log => {
                    const getIcon = (type) => {
                        switch(type) {
                            case 'user': return 'fa-user-plus text-green-600';
                            case 'project': return 'fa-folder-plus text-blue-600';
                            case 'submission': return 'fa-file-upload text-purple-600';
                            default: return 'fa-info-circle text-gray-600';
                        }
                    };
                    
                    return `
                        <div class="flex items-start space-x-3 p-4 bg-white rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                    <i class="fas ${getIcon(log.type)} text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${log.action}</p>
                                <p class="text-xs text-gray-500">${log.details}</p>
                            </div>
                            <div class="flex-shrink-0 text-xs text-gray-400">
                                ${new Date(log.timestamp).toLocaleDateString()} ${new Date(log.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } else {
            logsList.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Error loading activity logs</p>
                    <p class="text-sm text-gray-500">Status: ${response.status}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading admin logs:', error);
        logsList.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error loading activity logs</p>
                <p class="text-sm text-gray-500">${error.message}</p>
            </div>
        `;
    }
}

// Simple delete user function for admin panel
window.deleteUser = async function(userId) {
    if (!userId) {
        showNotification('No user ID provided', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showNotification('User deleted successfully', 'success');
            // Remove user row from UI
            const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (userRow) {
                userRow.remove();
            }
            // Reload users list
            await loadAdminUsers();
        } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Failed to delete user');
        }
    } catch (error) {
        console.error('Delete user error:', error);
        showNotification(error.message || 'Failed to delete user', 'error');
    }
};

async function loadAdminUsers() {
    console.log('Loading admin users...');
    const usersList = document.getElementById('admin-users-list');
    if (!usersList) {
        console.error('Admin users list element not found');
        return;
    }

    // Show loading state
    usersList.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading users...
            </td>
        </tr>
    `;

    try {
        const searchTerm = document.getElementById('admin-user-search')?.value?.toLowerCase() || '';
        const roleFilter = document.getElementById('admin-role-filter')?.value || '';
        
        console.log('Making request to:', `${API_BASE_URL}/users`);
        const response = await authenticatedFetch(`${API_BASE_URL}/users`);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const users = await response.json();
        console.log('Users API response:', users);
        console.log('Number of users:', users.length);
        
        // Filter users based on search and role
        const filteredUsers = users.filter(user => {
            const matchesSearch = !searchTerm || 
                user.name.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm);
            const matchesRole = !roleFilter || user.role === roleFilter;
            return matchesSearch && matchesRole;
        });
        
        if (filteredUsers.length === 0) {
            usersList.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No users found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            usersList.innerHTML = filteredUsers.map(user => {
                const roleColor = user.role === 'admin' ? 'bg-red-100 text-red-800' : 
                                     user.role === 'faculty' ? 'bg-green-100 text-green-800' : 
                                     'bg-blue-100 text-blue-800';
                const roleIcon = user.role === 'admin' ? 'fa-user-shield' : 
                                user.role === 'faculty' ? 'fa-chalkboard-teacher' : 
                                'fa-user';
                const iconColor = user.role === 'admin' ? 'text-red-600' : 
                                 user.role === 'faculty' ? 'text-green-600' : 
                                 'text-purple-600';
                const iconBg = user.role === 'admin' ? 'bg-red-100' : 
                              user.role === 'faculty' ? 'bg-green-100' : 
                              'bg-purple-100';
                
                const userId = user.id || user._id;
                return `
                    <tr data-user-id="${userId}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full ${iconBg} flex items-center justify-center">
                                        <i class="fas ${roleIcon} ${iconColor}"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                    <div class="text-sm text-gray-500">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${roleColor}">
                                ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${user.project_count || 0}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="window.viewUser('${userId}')" class="text-purple-600 hover:text-purple-900 mr-3 px-3 py-1 rounded border hover:bg-purple-50">View</button>
                            <button onclick="window.editUser('${userId}')" class="text-blue-600 hover:text-blue-900 mr-3 px-3 py-1 rounded border hover:bg-blue-50">Edit</button>
                            <button onclick="window.deleteUser('${userId}')" class="text-red-600 hover:text-red-900 px-3 py-1 rounded border hover:bg-red-50">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        console.log('Real user data loaded successfully');
    } catch (error) {
        console.error('Error loading users:', error);
        usersList.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-red-500">
                    Error loading users: ${error.message}. Please try again.
                </td>
            </tr>
        `;
    }
}

async function loadAdminProjects() {
    console.log('Loading admin projects...');
    const projectsList = document.getElementById('admin-projects-list');
    if (!projectsList) {
        console.error('Admin projects list element not found');
        return;
    }

    // Show loading state
    projectsList.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading projects...
            </td>
        </tr>
    `;

    try {
        const searchTerm = document.getElementById('admin-project-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-project-status-filter')?.value || '';
        
        const response = await authenticatedFetch(`${API_BASE_URL}/projects`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const projects = await response.json();
        console.log('Admin projects data:', projects);
        
        // Filter projects based on search and status
        const filteredProjects = projects.filter(project => {
            const matchesSearch = !searchTerm || 
                project.title.toLowerCase().includes(searchTerm) || 
                project.description.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || project.status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        
        if (filteredProjects.length === 0) {
            projectsList.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No projects found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            projectsList.innerHTML = filteredProjects.map(project => {
                const statusColor = project.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                   project.status === 'ongoing' ? 'bg-blue-100 text-blue-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                return `
                    <tr data-project-id="${project._id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${project.title}</div>
                                <div class="text-sm text-gray-500">${project.description.substring(0, 50)}...</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${project.student?.name || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${project.faculty?.name || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${project.status.charAt(0).toUpperCase() + project.status.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewProjectDetails('${project._id}')" class="text-purple-600 hover:text-purple-900 mr-3">View</button>
                            <button onclick="deleteProject('${project._id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading admin projects:', error);
        projectsList.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-red-500">
                    Error loading projects: ${error.message}
                </td>
            </tr>
        `;
    }
}

async function loadAdminSubmissions() {
    console.log('Loading admin submissions...');
    const submissionsList = document.getElementById('admin-submissions-list');
    if (!submissionsList) {
        console.error('Admin submissions list element not found');
        return;
    }

    // Show loading state
    submissionsList.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading submissions...
            </td>
        </tr>
    `;

    try {
        const searchTerm = document.getElementById('admin-submission-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-submission-status-filter')?.value || '';
        
        const response = await authenticatedFetch(`${API_BASE_URL}/submissions`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const submissions = await response.json();
        console.log('Admin submissions data:', submissions);
        
        // Filter submissions based on search and status
        const filteredSubmissions = submissions.filter(submission => {
            const matchesSearch = !searchTerm || 
                submission.title?.toLowerCase().includes(searchTerm) || 
                submission.project?.title?.toLowerCase().includes(searchTerm) ||
                submission.student?.name?.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || submission.status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        
        if (filteredSubmissions.length === 0) {
            submissionsList.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No submissions found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            submissionsList.innerHTML = filteredSubmissions.map(submission => {
                const statusColor = submission.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                   submission.status === 'rejected' ? 'bg-red-100 text-red-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                return `
                    <tr data-submission-id="${submission._id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${submission.title || 'Submission'}</div>
                                <div class="text-sm text-gray-500">Grade: ${submission.grade || 'Not graded'}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${submission.project?.title || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${submission.student?.name || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${submission.status ? submission.status.charAt(0).toUpperCase() + submission.status.slice(1) : 'Pending'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewSubmissionDetails('${submission._id}')" class="text-purple-600 hover:text-purple-900 mr-3">View</button>
                            <button onclick="gradeSubmission('${submission._id}')" class="text-blue-600 hover:text-blue-900 mr-3">Grade</button>
                            <button onclick="deleteSubmission('${submission._id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading admin submissions:', error);
        submissionsList.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-red-500">
                    Error loading submissions: ${error.message}
                </td>
            </tr>
        `;
    }
}

function generateReport(reportType) {
    console.log(`Generating ${reportType} report...`);
    showNotification(`Generating ${reportType} report... This feature will be implemented soon.`, 'info');
}

function loadAdminReports() {
    console.log('Admin reports section loaded');
    // Reports are static buttons, no data loading needed
}

async function viewSubmissionDetails(submissionId) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/submissions/${submissionId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const submission = await response.json();
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Submission Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Title</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.title || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Project</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.project?.title || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Student</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.student?.name || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.status || 'Pending'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Grade</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.grade || 'Not graded'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Submitted At</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.submittedAt ? new Date(submission.submittedAt).toLocaleString() : 'N/A'}</p>
                        </div>
                        ${submission.feedback ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Feedback</label>
                            <p class="mt-1 text-sm text-gray-900">${submission.feedback}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    } catch (error) {
        console.error('Error viewing submission details:', error);
        showNotification('Error loading submission details: ' + error.message, 'error');
    }
}

async function gradeSubmission(submissionId) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/submissions/${submissionId}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const submission = await response.json();
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Grade Submission</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="grade-submission-form">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Student</label>
                                <p class="mt-1 text-sm text-gray-900">${submission.student?.name || 'N/A'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Project</label>
                                <p class="mt-1 text-sm text-gray-900">${submission.project?.title || 'N/A'}</p>
                            </div>
                            <div>
                                <label for="grade" class="block text-sm font-medium text-gray-700">Grade</label>
                                <input type="number" id="grade" name="grade" min="0" max="100" value="${submission.grade || ''}" 
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                            </div>
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="status" name="status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                                    <option value="pending" ${submission.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="approved" ${submission.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${submission.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label for="feedback" class="block text-sm font-medium text-gray-700">Feedback</label>
                                <textarea id="feedback" name="feedback" rows="4" 
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500"
                                          placeholder="Enter feedback for the student...">${submission.feedback || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">
                                Save Grade
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('grade-submission-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const gradeData = {
                grade: parseInt(formData.get('grade')),
                status: formData.get('status'),
                feedback: formData.get('feedback')
            };
            
            try {
                const updateResponse = await authenticatedFetch(`${API_BASE_URL}/submissions/${submissionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gradeData)
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`HTTP error! status: ${updateResponse.status}`);
                }
                
                modal.remove();
                await loadAdminSubmissions();
                showNotification('Submission graded successfully!', 'success');
            } catch (error) {
                console.error('Error grading submission:', error);
                showNotification('Error grading submission: ' + error.message, 'error');
            }
        });
    } catch (error) {
        console.error('Error loading submission for grading:', error);
        showNotification('Error loading submission: ' + error.message, 'error');
    }
}

window.deleteSubmission = function(submissionId) {
    console.log('deleteSubmission function called with ID:', submissionId);
    
    if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
        console.log('User cancelled submission deletion');
        return;
    }
    
    console.log('User confirmed submission deletion, proceeding...');
    
    // Show loading state instead of removing immediately
    const submissionRow = document.querySelector(`tr[data-submission-id="${submissionId}"]`);
    if (submissionRow) {
        submissionRow.style.opacity = '0.5';
        submissionRow.style.pointerEvents = 'none';
        console.log('Submission row found and dimmed');
    } else {
        console.log('Submission row not found with data-submission-id:', submissionId);
    }
    
    authenticatedFetch(`${API_BASE_URL}/submissions/${submissionId}`, {
        method: 'DELETE'
    })
    .then(response => {
        console.log('Delete submission response status:', response.status);
        
        if (response.ok) {
            // Only remove after successful deletion
            if (submissionRow) {
                submissionRow.remove();
            }
            showNotification('Submission deleted successfully!', 'success');
            setTimeout(() => loadAdminSubmissions(), 1000);
        } else {
            // Restore the row on failure
            if (submissionRow) {
                submissionRow.style.opacity = '1';
                submissionRow.style.pointerEvents = 'auto';
            }
            return response.json().then(error => {
                console.error('Delete submission failed:', error);
                showNotification('Error deleting submission: ' + (error.message || 'Unknown error'), 'error');
            });
        }
    })
    .catch(error => {
        // Restore the row on error
        if (submissionRow) {
            submissionRow.style.opacity = '1';
            submissionRow.style.pointerEvents = 'auto';
        }
        console.error('Error deleting submission:', error);
        showNotification('Error deleting submission: ' + error.message, 'error');
    });
}

function loadAdminSettings() {
    console.log('Admin settings loaded');
}


function getRoleBadgeColor(role) {
    switch(role) {
        case 'student': return 'bg-blue-100 text-blue-800';
        case 'faculty': return 'bg-green-100 text-green-800';
        case 'admin': return 'bg-purple-100 text-purple-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

async function loadAdminProjects() {
    console.log('Loading admin projects...');
    
    try {
        const searchTerm = document.getElementById('admin-project-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-project-status-filter')?.value || '';
        
        const response = await authenticatedFetch(`${API_BASE_URL}/projects`);
        console.log('Admin projects response status:', response.status);
        
        if (response.ok) {
            let projects = await response.json();
            console.log('Admin projects data:', projects.length);
            
            // Apply filters
            if (statusFilter) {
                projects = projects.filter(project => project.status === statusFilter);
            }
            if (searchTerm) {
                projects = projects.filter(project => 
                    project.title.toLowerCase().includes(searchTerm) || 
                    project.description.toLowerCase().includes(searchTerm)
                );
            }
            
            const projectsList = document.getElementById('admin-projects-list');
            if (!projectsList) {
                console.error('admin-projects-list element not found');
                return;
            }
            
            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                            <i class="fas fa-project-diagram text-4xl mb-3 text-gray-400"></i>
                            <p class="text-lg">No projects found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            projectsList.innerHTML = projects.map(project => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${project.title}</div>
                        <div class="text-sm text-gray-500">${project.description ? project.description.substring(0, 50) + '...' : 'No description'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${project.faculty_name || project.created_by_name || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${project.student_ids ? project.student_ids.length : 0}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(project.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${project.deadline ? formatDate(project.deadline) : 'No deadline'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="viewProjectDetails('${project._id || project.id}')">View</button>
                        <button class="text-red-600 hover:text-red-900" onclick="deleteProject('${project._id || project.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        } else {
            console.error('Failed to load projects:', response.status);
            // Show sample projects data
            const projectsList = document.getElementById('admin-projects-list');
            if (projectsList) {
                projectsList.innerHTML = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">AI Research Project</div>
                            <div class="text-sm text-gray-500">Machine learning application for data analysis...</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Dr. Smith</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">ongoing</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Dec 31, 2024</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="viewProjectDetails('proj1')">View</button>
                            <button class="text-red-600 hover:text-red-900" onclick="deleteProject('proj1')">Delete</button>
                        </td>
                    </tr>
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">Web Development Portfolio</div>
                            <div class="text-sm text-gray-500">Full-stack web application with modern frameworks...</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Prof. Johnson</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">completed</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Nov 15, 2024</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="viewProjectDetails('proj2')">View</button>
                            <button class="text-red-600 hover:text-red-900" onclick="deleteProject('proj2')">Delete</button>
                        </td>
                    </tr>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading admin projects:', error);
        const projectsList = document.getElementById('admin-projects-list');
        if (projectsList) {
            projectsList.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p class="text-lg">Error loading projects</p>
                    </td>
                </tr>
            `;
        }
    }
}

async function loadAdminSubmissions() {
    console.log('Loading admin submissions...');
    const submissionsList = document.getElementById('admin-submissions-list');
    if (!submissionsList) {
        console.error('Admin submissions list element not found');
        return;
    }

    try {
        const searchTerm = document.getElementById('admin-submission-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('admin-submission-status-filter')?.value || '';
        
        const response = await authenticatedFetch(`${API_BASE_URL}/submissions`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const submissions = await response.json();
        console.log('Submissions API response:', submissions);
        
        // Filter submissions based on search and status
        const filteredSubmissions = submissions.filter(submission => {
            const matchesSearch = !searchTerm || 
                submission.project_title.toLowerCase().includes(searchTerm) || 
                submission.student_name.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || submission.status === statusFilter;
            return matchesSearch && matchesStatus;
        });
        
        if (filteredSubmissions.length === 0) {
            submissionsList.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        No submissions found matching your criteria.
                    </td>
                </tr>
            `;
        } else {
            submissionsList.innerHTML = filteredSubmissions.map(submission => {
                const statusColor = submission.status === 'reviewed' ? 'bg-green-100 text-green-800' : 
                                   'bg-blue-100 text-blue-800';
                
                const submittedDate = new Date(submission.submitted_on).toLocaleDateString();
                const grade = submission.grade !== null ? submission.grade : '-';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${submission.project_title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${submission.student_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${submittedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${submission.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewSubmission('${submission.id}')" class="text-purple-600 hover:text-purple-900 mr-3">View</button>
                            <button onclick="gradeSubmission('${submission.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Grade</button>
                            <button onclick="downloadSubmission('${submission.id}')" class="text-green-600 hover:text-green-900">Download</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        console.log('Real submission data loaded successfully');
    } catch (error) {
        console.error('Error loading submissions:', error);
        submissionsList.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-red-500">
                    Error loading submissions: ${error.message}. Please try again.
                </td>
            </tr>
        `;
    }
}

function loadAdminSettings() {
    // Settings are already displayed in the HTML, just add event handlers
    console.log('Admin settings loaded');
}

// Remove duplicate placeholder function - using the real implementation above

async function loadAdminAnalytics() {
    console.log('Loading admin analytics...');
    try {
        // Load analytics data
        const usersResponse = await authenticatedFetch(`${API_BASE_URL}/users`);
        const projectsResponse = await authenticatedFetch(`${API_BASE_URL}/projects`);
        
        if (usersResponse.ok && projectsResponse.ok) {
            const users = await usersResponse.json();
            const projects = await projectsResponse.json();
            
            // Calculate metrics
            const completedProjects = projects.filter(p => p.status === 'completed');
            const avgCompletionTime = completedProjects.length > 0 ? 
                Math.round(completedProjects.reduce((acc, p) => acc + 15, 0) / completedProjects.length) : 0;
            const successRate = projects.length > 0 ? 
                Math.round((completedProjects.length / projects.length) * 100) : 0;
            const userEngagement = users.length > 0 ? 
                Math.round((users.filter(u => u.role !== 'admin').length / users.length) * 100) : 0;
            
            // Update metrics
            const avgTimeEl = document.getElementById('admin-avg-completion-time');
            const successRateEl = document.getElementById('admin-success-rate');
            const engagementEl = document.getElementById('admin-user-engagement');
            
            if (avgTimeEl) avgTimeEl.textContent = avgCompletionTime;
            if (successRateEl) successRateEl.textContent = `${successRate}%`;
            if (engagementEl) engagementEl.textContent = `${userEngagement}%`;
            
            // Create charts with real data
            createAdminAnalyticsCharts(users, projects);
        } else {
            // Set default values on error
            const avgTimeEl = document.getElementById('admin-avg-completion-time');
            const successRateEl = document.getElementById('admin-success-rate');
            const engagementEl = document.getElementById('admin-user-engagement');
            
            if (avgTimeEl) avgTimeEl.textContent = '0';
            if (successRateEl) successRateEl.textContent = '0%';
            if (engagementEl) engagementEl.textContent = '0%';
            
            createAdminAnalyticsCharts([], []);
        }
    } catch (error) {
        console.error('Error loading admin analytics:', error);
        // Set default values on error
        const avgTimeEl = document.getElementById('admin-avg-completion-time');
        const successRateEl = document.getElementById('admin-success-rate');
        const engagementEl = document.getElementById('admin-user-engagement');
        
        if (avgTimeEl) avgTimeEl.textContent = '0';
        if (successRateEl) successRateEl.textContent = '0%';
        if (engagementEl) engagementEl.textContent = '0%';
        
        createAdminAnalyticsCharts([], []);
    }
}

function createAdminAnalyticsCharts(users = [], projects = []) {
    // Project Status Distribution Chart
    const statusCtx = document.getElementById('admin-project-status-chart');
    if (statusCtx) {
        const completedCount = projects.filter(p => p.status === 'completed').length;
        const ongoingCount = projects.filter(p => p.status === 'ongoing').length;
        const pendingCount = projects.filter(p => p.status === 'pending_approval').length;
        const openCount = projects.filter(p => p.status === 'open').length;
        
        new Chart(statusCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Completed', 'Ongoing', 'Pending', 'Open'],
                datasets: [{
                    data: [completedCount || 5, ongoingCount || 3, pendingCount || 2, openCount || 1],
                    backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#6B7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Monthly Trends Chart
    const trendsCtx = document.getElementById('admin-monthly-trends-chart');
    if (trendsCtx) {
        new Chart(trendsCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'New Projects',
                    data: [12, 19, 15, 25, 22, projects.length || 5],
                    backgroundColor: '#3B82F6'
                }, {
                    label: 'Completed Projects',
                    data: [8, 12, 10, 18, 15, projects.filter(p => p.status === 'completed').length || 3],
                    backgroundColor: '#10B981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
    }
}

function loadAdminReports() {
    // Add event listeners to report generation buttons
    document.querySelectorAll('#admin-reports button').forEach(button => {
        button.addEventListener('click', () => {
            alert(`Generating "${button.textContent.trim()}" report... This is a placeholder feature.`);
        });
    });
}

// Admin user management functions
function showAddUserModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New User</h3>
            <form id="add-user-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <input type="text" id="new-user-name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="new-user-email" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="new-user-password" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="new-user-role" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                        Add User
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('add-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addNewUser();
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
}

async function addNewUser() {
    const name = document.getElementById('new-user-name').value;
    const email = document.getElementById('new-user-email').value;
    const password = document.getElementById('new-user-password').value;
    const role = document.getElementById('new-user-role').value;
    
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name,
                email,
                password,
                role
            })
        });
        
        if (response.ok) {
            closeModal();
            await loadAdminUsers();
            showNotification('User added successfully!', 'success');
        } else {
            const error = await response.json();
            showNotification(error.detail || 'Failed to add user', 'error');
        }
    } catch (error) {
        console.error('Error adding user:', error);
        showNotification('Error adding user', 'error');
    }
}

window.viewUser = function(userId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">User Details</h3>
            <div id="user-details-content">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mr-3"></div>
                    <span class="text-gray-600">Loading user details...</span>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadUserDetails(userId);
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
}

async function loadUserDetails(userId) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users/${userId}`);
        if (response.ok) {
            const user = await response.json();
            const content = document.getElementById('user-details-content');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-user text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold text-gray-800">${user.name}</h4>
                            <p class="text-gray-600">${user.email}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm text-gray-500">Role</p>
                            <p class="font-medium">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm text-gray-500">Projects</p>
                            <p class="font-medium">${user.project_count || 0}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm text-gray-500">Joined</p>
                            <p class="font-medium">${new Date(user.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-sm text-gray-500">Status</p>
                            <p class="font-medium text-green-600">Active</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            throw new Error('Failed to load user details');
        }
    } catch (error) {
        console.error('Error loading user details:', error);
        document.getElementById('user-details-content').innerHTML = `
            <div class="text-center text-red-500 py-4">
                Error loading user details
            </div>
        `;
    }
}

window.editUser = function(userId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Edit User</h3>
            <div id="edit-user-content">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mr-3"></div>
                    <span class="text-gray-600">Loading user data...</span>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadEditUserForm(userId);
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
}

async function loadEditUserForm(userId) {
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users/${userId}`);
        if (response.ok) {
            const user = await response.json();
            const content = document.getElementById('edit-user-content');
            content.innerHTML = `
                <form id="edit-user-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" id="edit-user-name" value="${user.name}" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="edit-user-email" value="${user.email}" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="edit-user-role" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                            <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                            <option value="faculty" ${user.role === 'faculty' ? 'selected' : ''}>Faculty</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Update User
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateUser(userId);
            });
        } else {
            throw new Error('Failed to load user data');
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        document.getElementById('edit-user-content').innerHTML = `
            <div class="text-center text-red-500 py-4">
                Error loading user data
                <div class="mt-4">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Close
                    </button>
                </div>
            </div>
        `;
    }
}

async function updateUser(userId) {
    const name = document.getElementById('edit-user-name').value;
    const email = document.getElementById('edit-user-email').value;
    const role = document.getElementById('edit-user-role').value;
    
    try {
        const response = await authenticatedFetch(`${API_BASE_URL}/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name,
                email,
                role
            })
        });
        
        if (response.ok) {
            closeModal();
            await loadAdminUsers();
            showNotification('User updated successfully!', 'success');
        } else {
            const error = await response.json();
            showNotification(error.detail || 'Failed to update user', 'error');
        }
    } catch (error) {
        console.error('Error updating user:', error);
        showNotification('Error updating user', 'error');
    }
}

// Legacy unused function kept to avoid overriding the primary deleteUser.
// It now delegates to the main implementation if ever called.
window.legacyDeleteUser = function(userId) {
    if (!confirm('Are you sure you want to delete this user?')) {
        return;
    }
    
    // Remove from UI immediately
    const allTables = document.querySelectorAll('table');
    let rowToRestore = null;
    
    allTables.forEach(table => {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            if (row.innerHTML.includes(userId)) {
                rowToRestore = row.cloneNode(true);
                row.remove();
            }
        });
    });
    
    // Call backend API to delete from database
    fetch(`${API_BASE_URL}/users/${userId}`, {
        method: 'DELETE',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('userToken') || localStorage.getItem('access_token') || ''}`
        },
        body: JSON.stringify({ reassignProjects: true })
    })
    .then(response => {
        if (response.ok) {
            showNotification('User deleted successfully!', 'success');
        } else {
            // Restore row if backend deletion failed
            if (rowToRestore) {
                const usersList = document.getElementById('admin-users-list');
                if (usersList) {
                    usersList.appendChild(rowToRestore);
                }
            }
            showNotification('Failed to delete user from database', 'error');
        }
    })
    .catch(error => {
        // Restore row if API call failed
        if (rowToRestore) {
            const usersList = document.getElementById('admin-users-list');
            if (usersList) {
                usersList.appendChild(rowToRestore);
            }
        }
        showNotification('Error deleting user: ' + error.message, 'error');
    });
}

window.closeModal = function() {
    const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
    modals.forEach(modal => modal.remove());
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function viewProjectDetails(projectId) {
    alert(`View project details for ID: ${projectId} (placeholder)`);
}


function viewSubmissionDetails(submissionId) {
    alert(`View submission details for ID: ${submissionId} (placeholder)`);
}

function deleteSubmission(submissionId) {
    if (confirm('Are you sure you want to delete this submission?')) {
        alert(`Delete submission ID: ${submissionId} (placeholder)`);
    }
}

// Initialize the auth modal or app based on token
window.addEventListener('DOMContentLoaded', async () => {
    applySavedTheme();
    if (userToken) {
        appContainer.style.display = 'flex';
        await initializeApp();
    } else {
        authModal.style.display = 'flex';
        setTimeout(() => {
            authModal.querySelector('.modal-content-animated').classList.add('show');
        }, 10);
    }
    
    // Add sidebar navigation event handlers
    document.addEventListener('click', (e) => {
        if (e.target.closest('.sidebar-link')) {
            e.preventDefault();
            const link = e.target.closest('.sidebar-link');
            const sectionId = link.getAttribute('data-section');
            
            if (sectionId) {
                // Remove active class from all sidebar links
                document.querySelectorAll('.sidebar-link').forEach(l => {
                    l.classList.remove('active', 'text-purple-700', 'bg-purple-50');
                    l.removeAttribute('aria-current');
                });
                
                // Add active class to clicked link
                link.classList.add('active', 'text-purple-700', 'bg-purple-50');
                link.setAttribute('aria-current', 'page');
                
                // Hide all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                // Show selected section
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active');
                    
                    // Load section data
                    console.log(`Loading section: ${sectionId}`);
                    loadSectionData(sectionId);
                } else {
                    console.error(`Section not found: ${sectionId}`);
                }
            }
        }
    });
});

    </script>
</body>
</html>

